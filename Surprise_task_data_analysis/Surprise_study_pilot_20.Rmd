---
title: "Surprise study pilot 20"
author: "Marjan Biria"
date: "2024-03-19"
output: 
    pdf_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lme4)
library(parameters)
library(broom.mixed)
library(purrr)
library(conflicted)
library(stringr)
library(readxl)
```


\newpage
# Study description

This study is the same as pilot 19, except we have now moved the second prediction after the feedback to see how they take the feedback into account, and allows us to re-calculate the PE differently for the two subjective predictions.

The Gorilla experiment is the following: https://app.gorilla.sc/admin/project/129240
The task is the following: https://app.gorilla.sc/admin/task/793630/editor



```{r echo=FALSE, warning=FALSE, message=FALSE}
df20_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4_task_main.csv")
df20_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4_mini_spin.csv")
df20_cesd <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4/SUP_PRF_p20_vid_bigPE_2pred_afterfdbk_nohist_4jud_v4_ces_d.csv")

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# extract CES-D scores
CESD_data_clean <- df20_cesd[, c(32, 34, 36, 38, 40, 42, 44, 46,48,50,
                                 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 71 )]
# Identify non-ID variable columns
non_id_cols <- setdiff(names(CESD_data_clean), "Random_ID")

# Convert non-ID variables to numeric
CESD_data_clean[, non_id_cols] <- lapply(CESD_data_clean[, non_id_cols], as.numeric)

#change numbers to match CES-D scoring system
excluded_columns <-  c("Random_ID", "Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                       "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                       "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                       "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
                  

CESD_data_clean<- CESD_data_clean %>%
  mutate(across(-excluded_columns , ~ case_when(
    . == 1 ~ 0,
    . == 2 ~ 1,
    . == 3 ~ 2,
    . == 4 ~ 3,
    TRUE ~ .
  )))


other_columns <- c("Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                   "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                   "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                   "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
CESD_data_clean<- CESD_data_clean %>%
  mutate(across(other_columns , ~ case_when(
    . == 1 ~ 3,
    . == 2 ~ 2,
    . == 3 ~ 1,
    . == 4 ~ 0,
    TRUE ~ .
  )))

#scoring----
CESD_scores <-  numeric(length(CESD_data_clean$Random_ID))
CESD_scores <- 0
Questions <- c(1:20)

for (i in 1:nrow(CESD_data_clean)) {
  CESD_score <- sum(CESD_data_clean[i, Questions])
  CESD_scores[i] <- CESD_score
}

CESD_data_clean$CESD_score <-  CESD_scores

CESD_data_clean$Depression_Threshold<- 0
CESD_data_clean$Depression_status <- "Not_Depressed"

#Assign "1" if they meet Depression threshold 
for (i in 1:nrow(CESD_data_clean)) {
  if (CESD_data_clean$CESD_score[i] >= 16) {
    CESD_data_clean$Depression_Threshold[i] <- 1
    CESD_data_clean$Depression_status[i] <- "Depressed"
  }
}
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# We have now different names for different screens:
# Prediction (how well do you think you performed?)
# prediction_2 (how well do you think you performed?)
# feedback (This is how well X thought you performed)
# First 4 trials are with the histograms and are called "Trials_Histogram" in Display column instead of "Trials"
# The trial numbers start from 1 again after the histograms so we need to concatenate them all.
# Let's rename them to "Trials" to extract them together with the rest of the trials

df20_raw$Trial.Number[df20_raw$Display == "Trials "] <- df20_raw$Trial.Number[df20_raw$Display == "Trials "] + 4

df20_raw <- df20_raw %>%
  mutate(Screen = if_else(Screen == "Prediction", "Prediction ", Screen))


df20_raw <- df20_raw %>%
  mutate(Display = if_else(Display == "Trials_Histogram", "Trials ", Display))

df20_spin <- df20_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears."
  )

df20_spin <- df20_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()


# create a new df20 that only keeps the columns we need
df20 <- df20_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df20 <- df20 %>% dplyr::filter(Response.Type != "info")

df20 <- df20 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df20$Screen <- ifelse(df20$Trial.Number == 1 & (df20$Display == "Mood " | df20$Display == "Anxiety "), "BL_1",
                      ifelse(df20$Trial.Number == 2 & (df20$Display == "Mood " | df20$Display == "Anxiety "), "BL_2", 
                             df20$Screen))

df20$m_hist <- ifelse(df20$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(df20$Spreadsheet..Histogram == "h3.png", 37,
                                                  ifelse(df20$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df20$Spreadsheet..Histogram == "h7.png", 71, NA))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df20 <- df20 %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Exit") |
      (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
      (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df20$Trial.Number <- ifelse(df20$Display == 'Mood ' | df20$Display == 'Anxiety ', df20$Trial.Number - 2, df20$Trial.Number)
df20$Display <- ifelse(df20$Display == 'Mood ' | df20$Display == 'Anxiety ', "Trials", df20$Display)

# renaming the feedback column to fdbk
names(df20)[names(df20) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df20$SubjPE <- ifelse(df20$Screen == "Prediction ", df20$fdbk - df20$Response, NA)
df20$PE <- ifelse(df20$Screen == "Prediction ", df20$fdbk - df20$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df20$fdbk <- ifelse(df20$Screen == "Prediction ", df20$fdbk, NA)
df20$m_hist <- ifelse(df20$Screen == "Prediction ", df20$m_hist, NA)
df20$stress_level <- ifelse(df20$Screen == "Screen 12", df20$Response, NA)

long_df20 <- df20 %>%
  dplyr::select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE, stress_level) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE, stress_level),
               names_to = "Screen",
               values_to = "Response")

# This will keep only the rows where 'Response' is not NA
long_df20 <- long_df20[!is.na(long_df20$Response), ]

# Selecting relevant columns from the original df20
df20 <- df20 %>%
  dplyr::select(-c(fdbk, m_hist, PE, SubjPE, stress_level))

# Binding the rows together
df20 <- bind_rows(df20, long_df20)

df20$Response <- as.numeric(df20$Response)

# looking at the relationship between PE and SubjPE
df20_PE <- subset(df20, Screen == "PE")
names(df20_PE)[names(df20_PE) == "Screen"] <- "Screen_PE"
names(df20_PE)[names(df20_PE) == "Response"] <- "Response_PE"

df20_SubjPE <- subset(df20, Screen == "SubjPE")
names(df20_SubjPE)[names(df20_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df20_SubjPE)[names(df20_SubjPE) == "Response"] <- "Response_SubjPE"

df20_fdbk <- subset(df20, Screen == "fdbk")
names(df20_fdbk)[names(df20_fdbk) == "Screen"] <- "Screen_fdbk"
names(df20_fdbk)[names(df20_fdbk) == "Response"] <- "Response_fdbk"

df20_hist <- subset(df20, Screen == "m_hist")
names(df20_hist)[names(df20_hist) == "Screen"] <- "Screen_m_hist"
names(df20_hist)[names(df20_hist) == "Response"] <- "Response_m_hist"

df20_stress_level <- subset(df20, Screen == "Screen 12")
names(df20_stress_level)[names(df20_stress_level) == "Screen"] <- "Screen_stress_level"
names(df20_stress_level)[names(df20_stress_level) == "Response"] <- "Response_stress_level"

df20_predic <- subset(df20, Screen == "Prediction ")
names(df20_predic)[names(df20_predic) == "Screen"] <- "Screen_pred"
names(df20_predic)[names(df20_predic) == "Response"] <- "Response_pred"

df20_predic2 <- subset(df20, Screen == "prediction_2")
names(df20_predic2)[names(df20_predic2) == "Screen"] <- "Screen_pred2"
names(df20_predic2)[names(df20_predic2) == "Response"] <- "Response_pred2"

# df20_cert <- subset(df20, Screen == "Certainty rating ")
# names(df20_cert)[names(df20_cert) == "Screen"] <- "Screen_certainty"
# names(df20_cert)[names(df20_cert) == "Response"] <- "Response_certainty"

list_of_dfs_20 <- list(df20_PE, df20_fdbk, df20_hist, df20_predic, df20_predic2, df20_SubjPE)

# Using reduce with inner_join
merged_df20 <- reduce(list_of_dfs_20, inner_join, by = c("Random_ID", "Trial.Number"))

df20_Anxious <- subset(df20, Screen == "Anxious")
names(df20_Anxious)[names(df20_Anxious) == "Screen"] <- "Screen_Ax"
names(df20_Anxious)[names(df20_Anxious) == "Response"] <- "Response_Ax"

df20_Happy <- subset(df20, Screen == "Happy")
# df20_fdbk <- subset(df20, Screen == "Prediction")
names(df20_Happy)[names(df20_Happy) == "Screen"] <- "Screen_H"
names(df20_Happy)[names(df20_Happy) == "Response"] <- "Response_H"

final_df20 <- merged_df20 %>%
  inner_join(df20_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df20_Happy, by = c("Random_ID", "Trial.Number"))


# subset only the columns we are interested in
final_df20 <- final_df20[c("Trial.Number", "Random_ID", "Response_H", "Response_Ax", "Response_fdbk", "Response_SubjPE", "Response_PE", "Response_m_hist", "Response_pred", "Response_pred2")]

final_df20 <- final_df20 %>%
  left_join(df20_spin %>% dplyr::select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df20 <- final_df20 %>%
  left_join(df20_stress_level %>% dplyr::select(Random_ID, Response_stress_level), by = "Random_ID")

final_df20 <- final_df20 %>%
  left_join(CESD_data_clean %>% dplyr::select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df20$Social_Anxiety <- ifelse(final_df20$mini_SPIN_total >= 6, "high", "low")

final_df20$SubjPE_2 <- final_df20$Response_pred2 - final_df20$Response_pred
final_df20$SubjPE_3 <- final_df20$Response_fdbk - final_df20$Response_pred2


# # List of people who clearly stated they believed the judges were not real
# specified_ids <- c("SUPPRF04400", "SUPPRF43481", "SUPPRF74749", "SUPPRF80118", 
#                    "SUPPRF76403", "SUPPRF08502", "SUPPRF25205", "SUPPRF82413", 
#                    "SUPPRF20812", "SUPPRF20869", "SUPPRF84532", "SUPPRF76734", 
#                    "SUPPRF02691")
# 
# # Creating a new column based on condition to divide people into "No" or "Yes/maybe/NA" category about believability 
# final_df20$believability <- ifelse(final_df20$Random_ID %in% specified_ids, "No", "Yes/maybe/NA")


write.csv(final_df20, "pilot_20_variables.csv", row.names = FALSE)


final_df20 %>%
  group_by(Random_ID) %>%
  summarise(Trial.Number = n())

write.csv(final_df20, "final_df20_with_stresslevels.csv", row.names = FALSE)

```



\newpage 
# Relationship between prediction and mean histogram

Reminder: we now have only 4 judges/histograms and people will see the histograms only once in the very beginning. We have an average correlation of 0.33 between mean of histogram and prediction (as opposed to 0.80 in previous 3 pilots when prediction was before performance; and 0.60 when prediction was after performance).

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_m_hist, Response_pred, method = "spearman", use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))

# # calculate the average correlation across all individuals and print it
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mean_hist and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_m_hist, y = Response_pred, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +
  # labs(color="Legend") +
  theme_minimal() +
  xlab("prediction") +
  ylab("mean_histogram") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),
        axis.text.y = element_text(size = 5.5),
        strip.text.x = element_text(face = "bold"),
        strip.text.y = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
  
```

\newpage 
# Relationship between Anxiety and SubjPE

SubjPE = feedback - pre-prediction (before performance)
The correlation with anxiety has always been weaker than mood, but now it is closer to 0 (-0.037) as opposed to ~-0.10 we used to get!

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df20, aes(x = Response_SubjPE, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```

\newpage 
# Relationship Anxiety and SubjPE_2 (pred2 - pred1)

SubjPE_2 was calculated by looking at the difference between the ratings on questions before and after the performance: "how well you performed?" minus "how well do you think you will performe?" or [post - pre] ratings. 

In this pilot the second rating was asked AFTER they received feedback about their performance. The correlation with anxiety is slightly higher here: ~-0.06 but still lower than the old SubjPE x axiety correlations we've had.


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, SubjPE_2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE_2:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df20, aes(x = SubjPE_2, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE2: post_prediction - pre-prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```

\newpage 
# Relationship between predictions before and after performance 

We will see in the following pages that the relationship between SubjPE and SubjPE3 with mood and anxiety is very similar. If the predictions before and after performance would be very similar (highly correlated), it would make sense as SubjPE is calculated as[feedback - prediction_before_performance] and SubjPE_3 is calcylated as[feedback - prediction_after_performance]. So they don't seem to be highly correlated r = 0.33. We were worried about the fact that feedback might influence people's predictions and I will next look at the correlation between post-prediction and feedback.


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_M <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_pred, Response_pred2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between predictions before and after performance:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_pred, y = Response_pred2, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction before performance") + 
  ylab("Prediction after performance") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(0, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))
  
```


\newpage 
# Relationship between post-prediction and feedback

They are not very highly correlated (r = 0.33) which could mean: 1) either they don't take the feedback too much into account which is against what we thought and not necessarily a bad thing, it would allow us to dissociate the impact of the reward from feedback and their own prediction on emotions; or 2) their predictions are not meaningful/random. Are there any other possibilities/interpretations?


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_pred2, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between post-prediction and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_fdbk, y = Response_pred2, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Post-prediction") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```



\newpage 
# Relationship between Anxiety and SubjPE_3

SubjPE_3 = feedback - prediction after performance

This one is literally almost 0: r = 0.01, but maybe it does make sense if the feedback and post-prediction would be in the same direction with the same size?

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, SubjPE_3, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE_3:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df20, aes(x = SubjPE_3, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE_3: feedback - prediction_post_performance") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```


\newpage 
# Relationship between Mood and SubjPE

```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_SubjPE, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```

\newpage 
# Relationship between Mood and SubjPE_2

Again, here SubjPE_2 = prediction_2 - prediction_1; [post - pre] ratings (question about how they think they **DID** perform - **WILL** perform).
Again, this relationship has dropped from ~0.25 to r = 0.14.

```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, SubjPE_2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE_2:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = SubjPE_2, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```


\newpage 
# Relationship between Mood and SubjPE_3

SubjPE_3 = feedback - post_prediction (question about how they think they performed).


```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, SubjPE_3, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE_3:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = SubjPE_3, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE_3: feedback - prediction_post_performance") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# \newpage 
# Relationship between SubjPE and SubjPE_3
# correlations_M <- final_df20 %>%
#   group_by(Random_ID) %>%
#   summarise(correlation = cor(Response_SubjPE, SubjPE_3, use = "complete.obs")) %>%
#   mutate(label = paste("R = ", round(correlation, digits = 2))) 
# 
# # calculate the average correlation across all individuals and print it 
# average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
# message_to_print_H <- paste("average correlation between mood and SubjPE_3:", average_correlation)
# 
# print(message_to_print_H)
# 
# ggplot(final_df20, aes(x = SubjPE_3, y = Response_SubjPE, color = Social_Anxiety, group= Social_Anxiety)) +
#   geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
#   geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
#   # labs(color="Legend") +
#   theme_minimal() +
#   xlab("SubjPE_3: feedback - prediction_post_performance") + 
#   ylab("SubjPE: feedback - prediction_pre_performance") +
#     facet_wrap(~ Random_ID, scales = "free") +
#     geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
#     theme(strip.text = element_text(size = 6),
#         axis.text.x = element_text(size = 5.5),  
#         axis.text.y = element_text(size = 5.5),  
#         strip.text.x = element_text(face = "bold"),  
#         strip.text.y = element_text(face = "bold"),  
#         panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank()) +
#   ylim(c(0, 100)) + 
#   scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
#   xlim(c(-100, 100)) + 
#   scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```


\newpage 
# Relationship between Mood and feedback

This one is also slightly reduced from an average correlation of 0.30 to average r = 0.24.

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Mfd <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Mfd$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_fdbk, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Mfd, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Mood and prediction (pre-performance)

Pre-performance prediction is related to mood only slightly ~ 0.14 which is similar to previous pilot.

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and prediction before performance:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_pred, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction pre performance") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Mood and prediction (post-performance)

Post-performance prediction is related to mood slightly higher than feedback r = 0.266

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_pred2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and prediction after performance:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_pred2, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction post performance") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Anxiety and prediction

What is interesting now, is that the pre-performance prediction is showing a correlation of -0.16 which is much higher than previous pilots and as high as the correlation with feedback and anxiety! I wonder whether there is a learning going on, for example, if we look at predictions in the beginning they would not show a big impact on anxiety, but as they progress this relationship becomes bigger. One way we could look at this could be to look at this correlation on a trial by trial basis across all subjects, but we will have different scores/judges across subjects, wouldn't that influence the results? How can we look at this by doing a more complicated/more sophisticated modelling?


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_pred, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Pre performance prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Anxiety and prediction2

Now this has been the strongest correlation with anxiety we have every had (r = -0.21), almost as big as the effect size for mood! I even excluded one subject who showed a very high correlation which could have been caused by only a few data points and the correlation still remains around -0.19!

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_pred2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_pred2, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Post performance prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```
\newpage 
# Relationship Anxiety & predic_2 (excluding 1 subject)

Here I exclude one subject who has a correlation of -0.97, most likely caused by a few data points to see how the results change (subject SUPPRF82392). Even after excluding this subject the correlation is -0.19 which has been the strongest correlation with anxiety we have had so far.

```{r echo=FALSE, warning=FALSE, message=FALSE}
final_df20_excluded <- final_df20 %>% dplyr::filter(Random_ID != "SUPPRF82392")

correlations <- final_df20_excluded %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_pred2, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df20_excluded, aes(x = Response_pred2, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Post performance prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```


\newpage 
# Relationship between Anxiety and feedback

The correlation between feedback and anxiety is quite similar to previous pilots.

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df20 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df20, aes(x = Response_fdbk, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# trying to keep the BL_1 and BL_2 mood and anxiety ratings
df20_with_BL <- df20_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df20_with_BL <- df20_with_BL %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df20_with_BL <- df20_with_BL %>% dplyr::filter(Response.Type != "info")

df20_with_BL$Screen <- ifelse(df20_with_BL$Trial.Number == 1 & (df20_with_BL$Display == "Mood " | df20_with_BL$Display == "Anxiety "), "BL_1",
                      ifelse(df20_with_BL$Trial.Number == 2 & (df20_with_BL$Display == "Mood " | df20_with_BL$Display == "Anxiety "), "BL_2", 
                             df20_with_BL$Screen))

df20_with_BL$m_hist <- ifelse(df20_with_BL$Spreadsheet..Histogram == "h1.png", 20,
                      ifelse(df20_with_BL$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(df20_with_BL$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(df20_with_BL$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(df20_with_BL$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(df20_with_BL$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df20_with_BL$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(df20_with_BL$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df20_with_BL <- df20_with_BL %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Anxiety ") |
      (Display == "Mood ")
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df20_with_BL$Trial.Number <- ifelse(df20_with_BL$Display == 'Mood ' | df20_with_BL$Display == 'Anxiety ', df20_with_BL$Trial.Number - 2, df20_with_BL$Trial.Number)
# df20_with_BL$Display <- ifelse(df20_with_BL$Display == 'Mood ' | df20_with_BL$Display == 'Anxiety ', "Trials", df20_with_BL$Display)

final_df20_with_BL <- df20_with_BL[c("Trial.Number", "Display", "Screen", "Response", "Random_ID")]

final_df20_with_BL <- final_df20_with_BL %>%
  left_join(df20_spin %>% dplyr::select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df20_with_BL <- final_df20_with_BL %>%
  left_join(CESD_data_clean %>% dplyr::select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df20_with_BL$Social_Anxiety <- ifelse(final_df20_with_BL$mini_SPIN_total >= 6, "high", "low")


```



\newpage 
# Mood over time 

```{r echo=FALSE, warning=FALSE, message=FALSE}
df20_BL_ax <- subset(final_df20_with_BL, Display == "Anxiety ")
df20_BL_H <- subset(final_df20_with_BL,Display == "Mood ")

ggplot(df20_BL_H, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Mood across time",
       x = "Trial Number",
       y = "Mood",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Anxiety over time 

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(df20_BL_ax, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Anxiety across time",
       x = "Trial Number",
       y = "Anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Prediction before performance over time 

Red line presents until what points histograms were presented (4 first trials only).

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(final_df20, aes(x = Trial.Number, y = Response_pred)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 5, linetype = "dashed", color = "red") + 
  theme_minimal() +
  labs(title = "Prediction before performance across time",
       x = "Trial Number",
       y = "Pre performance prediction",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(1, 48, by = 10), limits = c(1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Prediction after feedback over time 


```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(final_df20, aes(x = Trial.Number, y = Response_pred2)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 5, linetype = "dashed", color = "red") + 
  theme_minimal() +
  labs(title = "Prediction after performance across time",
       x = "Trial Number",
       y = "Post performance prediction",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(1, 48, by = 10), limits = c(1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


\newpage 
# Stress levels and social anxiety

```{r echo=FALSE, warning=FALSE, message=FALSE}
onetrial_final_df20 <- subset(final_df20, final_df20$Trial.Number == 1)


ggplot(onetrial_final_df20, aes(x = Social_Anxiety, y = Response_stress_level , fill = Social_Anxiety)) +
  geom_boxplot(outlier.colour = "black") +
  stat_boxplot(geom = "errorbar",
               width = 0.15) + 
  geom_point(color = "black", position = position_jitter(width = 0.1), alpha = 0.7) +
  theme_minimal() +
  # labs(x = "Display", y = "Response") +
  # scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  # ggtitle("Average anxiety ratings in pilots 1 and 2 in socially anxious people") +
  xlab("") + 
  ylab("stress levels (0-10)") +
  # facet_wrap(~pilot_nr, scales = "free") +
  # scale_fill_manual(values = c("black", "purple", "darkgreen", "blue"))+
  # ylim(c(50, 100)) + 
  scale_y_continuous(breaks = seq(0, 10, by = 1), limits = c(1, 10))+
  theme(
    panel.grid.major = element_blank(),  # Removes major grid lines
    panel.grid.minor = element_blank(),  # Removes minor grid lines
    panel.border = element_blank(),      # Removes the border line
    axis.line = element_blank(),          # Removes axis lines
    plot.background = element_rect(fill = "white", colour = NA)   # Ensure plot background is white
  )

```

\newpage
# LME models for Mood and SubjPE

The best model seems to 

```{r echo=FALSE, warning=FALSE, message=FALSE}
# model1 <- lme4::lmer(Response_H ~ Response_SubjPE + (1 | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# model2 <- lme4::lmer(Response_H ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# model3 <- lme4::lmer(Response_H ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model4 <- lme4::lmer(Response_H ~ Response_fdbk + (1 | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# model5 <- lme4::lmer(Response_H ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# model6 <- lme4::lmer(Response_H ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# 
# model7a <- lme4::lmer(Response_Ax ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7b <- lme4::lmer(Response_Ax ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7c <- lme4::lmer(Response_Ax ~ Response_pred2 + Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7d <- lme4::lmer(Response_Ax ~ Response_pred2 + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7e <- lme4::lmer(Response_Ax ~ Response_pred2 + (1 |Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7f <- lme4::lmer(Response_Ax ~ Response_pred2 + Response_pred + (1 |Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7g <- lme4::lmer(Response_Ax ~ Response_pred2 * mini_SPIN_total + (1 |Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# model7h <- lme4::lmer(Response_Ax ~ Response_pred2 + Response_fdbk  + (Response_fdbk | Random_ID), data = final_df20, control=lmerControl(optimizer="bobyqa"))
# 
# 
# 
# 
# 
# AIC(model7a)
# AIC(model7b)
# AIC(model7c)
# AIC(model7d)
# AIC(model7e)
# AIC(model7f)
# AIC(model7g)
# AIC(model7h)
# 
# 
# summary(model1)
# summary(model2)
# summary(model3)
# summary(model4)
# summary(model5)
# summary(model6)
# 
# AIC(model1)
# AIC(model2)
# AIC(model3)
# AIC(model4)
# AIC(model5)
# AIC(model6)
# 
# # anova(model2, model5)
# 
# coef_fixed <- fixef(model5)
# intercept_Mood <- coef_fixed[1]
# slope_Mood <- coef_fixed[2]
# standard_beta_fdbk <- parameters:: standardise_parameters (model5)
# standard_beta_subjPE <- parameters:: standardise_parameters (model2)
# # test <- model5 %>% broom.mixed::tidy("fixed") 
```


\newpage 
# Individual plots with LME for Mood with SubjPE
When looking at subjective PE, the best model is  Mood ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 

```{r echo=FALSE, warning=FALSE, message=FALSE}

# ggplot(final_df20, aes(x=Response_SubjPE, y=Response_H)) +
#   geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
#   scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
#   geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
#   xlab("Subjective PE") + 
#   ylab("Mood") +
#   ggtitle("Relationship between Mood and subjective PE",
#           subtitle = paste("estimated slopes of the association in n = ", 
#                            length(unique(final_df20$Random_ID))))+
#   theme(plot.title = element_text(size=15), plot.subtitle = element_text(size = 10))+
#   theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
#   theme(axis.title = element_text(size = 10))+
#   annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
#                                                  round(standard_beta_subjPE$CI_low[2],2), "-", 
#                                                  round(standard_beta_subjPE$CI_high[2],2))) +
#   scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
#   scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

# ggsave(filename = "p15_m.png", plot = p15_m, dpi = 300, width = 6, height = 4)
  
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# TO DO:
# - look at the plots dividing people according believability
# - look at LME's taking SA into account, taking fdbk into account in the relationship of the pre and post ratings
# 
Yes:
1)SUPPRF67318
2)SUPPRF60790
3)SUPPRF84585
4) SUPPRF99019
5)SUPPRF60041
6)SUPPRF74365
7)SUPPRF88823
8)SUPPRF83047
9)SUPPRF58947
10)SUPPRF74320
11)SUPPRF91090
12)SUPPRF92030
13)SUPPRF51693

No:
1)SUPPRF19125
2)SUPPRF34851
3) SUPPRF68963
4)SUPPRF98765
5) SUPPRF21256
6)SUPPRF68317
7)SUPPRF22695
8)SUPPRF24929
9)SUPPRF42659
10)SUPPRF04651
11)SUPPRF35950
12)SUPPRF48827
13)SUPPRF43967

NA:
1)SUPPRF82392
2) SUPPRF52787
3) SUPPRF97604
4)SUPPRF42335
5)SUPPRF30067
6)SUPPRF74430
7)SUPPRF00347
8)SUPPRF41805
9)SUPPRF55636
10)SUPPRF27495
11)SUPPRF16624
```



