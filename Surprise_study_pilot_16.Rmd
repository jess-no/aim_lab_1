---
title: "Surprise study pilot 16"
author: "Marjan Biria"
date: "2024-02-19"
output: 
    pdf_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lme4)
library(parameters)
library(broom.mixed)
library(purrr)
library(conflicted)
library(stringr)
library(readxl)
```


\newpage
# Study description

This study is the same as pilot 15, but we have moved the prediction before participant's performance to see whether it would make a difference in the relationship between subjective PE and emotion ratings. Although participants won't take their performance into account, this would be closer to what happens during therapy.

The Gorilla experiment is the following: https://app.gorilla.sc/admin/project/125827
The task is the following: https://app.gorilla.sc/admin/task/772053/editor



```{r echo=FALSE, warning=FALSE, message=FALSE}
df16_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr2_early_pred/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2_task_main.csv")
df16_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr2_early_pred/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2_mini_spin.csv")
df16_cesd <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr2_early_pred/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2/SUP_PRF_pilot_vid_big_PE_narr2_early_pred_v2_ces_d.csv")

df16_raw <- df16_raw %>%
  dplyr::filter(Random_ID != "SUPPRF83198")

df16_spin <- df16_spin %>%
  dplyr::filter(Random_ID != "SUPPRF83198")

df16_cesd <- df16_cesd %>%
  dplyr::filter(Random_ID != "SUPPRF83198")

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# extract CES-D scores
CESD_data_clean <- df16_cesd[, c(32, 34, 36, 38, 40, 42, 44, 46,48,50,
                                 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 71 )]
# Identify non-ID variable columns
non_id_cols <- setdiff(names(CESD_data_clean), "Random_ID")

# Convert non-ID variables to numeric
CESD_data_clean[, non_id_cols] <- lapply(CESD_data_clean[, non_id_cols], as.numeric)

#change numbers to match CES-D scoring system
excluded_columns <-  c("Random_ID", "Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                       "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                       "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                       "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
                  

CESD_data_clean<- CESD_data_clean %>%
  mutate(across(-excluded_columns , ~ case_when(
    . == 1 ~ 0,
    . == 2 ~ 1,
    . == 3 ~ 2,
    . == 4 ~ 3,
    TRUE ~ .
  )))


other_columns <- c("Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                   "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                   "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                   "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
CESD_data_clean<- CESD_data_clean %>%
  mutate(across(other_columns , ~ case_when(
    . == 1 ~ 3,
    . == 2 ~ 2,
    . == 3 ~ 1,
    . == 4 ~ 0,
    TRUE ~ .
  )))

#scoring----
CESD_scores <-  numeric(length(CESD_data_clean$Random_ID))
CESD_scores <- 0
Questions <- c(1:20)

for (i in 1:nrow(CESD_data_clean)) {
  CESD_score <- sum(CESD_data_clean[i, Questions])
  CESD_scores[i] <- CESD_score
}

CESD_data_clean$CESD_score <-  CESD_scores

CESD_data_clean$Depression_Threshold<- 0
CESD_data_clean$Depression_status <- "Not_Depressed"

#Assign "1" if they meet Depression threshold 
for (i in 1:nrow(CESD_data_clean)) {
  if (CESD_data_clean$CESD_score[i] >= 16) {
    CESD_data_clean$Depression_Threshold[i] <- 1
    CESD_data_clean$Depression_status[i] <- "Depressed"
  }
}
```


```{r echo=FALSE, warning=FALSE, message=FALSE}

df16_spin <- df16_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears."
  )

df16_spin <- df16_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()


# create a new df16 that only keeps the columns we need
df16 <- df16_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df16 <- df16 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df16$Screen <- ifelse(df16$Trial.Number == 1 & (df16$Display == "Mood " | df16$Display == "Anxiety "), "BL_1",
                      ifelse(df16$Trial.Number == 2 & (df16$Display == "Mood " | df16$Display == "Anxiety "), "BL_2", 
                             df16$Screen))

df16$m_hist <- ifelse(df16$Spreadsheet..Histogram == "h1.png", 20,
                      ifelse(df16$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(df16$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(df16$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(df16$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(df16$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df16$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(df16$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df16 <- df16 %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Exit") |
      (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
      (Display == "Mood " & !Trial.Number %in% c(1, 2))
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df16$Trial.Number <- ifelse(df16$Display == 'Mood ' | df16$Display == 'Anxiety ', df16$Trial.Number - 2, df16$Trial.Number)
df16$Display <- ifelse(df16$Display == 'Mood ' | df16$Display == 'Anxiety ', "Trials", df16$Display)

# renaming the feedback column to fdbk
names(df16)[names(df16) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df16$SubjPE <- ifelse(df16$Screen == "Prediction ", df16$fdbk - df16$Response, NA)
df16$PE <- ifelse(df16$Screen == "Prediction ", df16$fdbk - df16$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df16$fdbk <- ifelse(df16$Screen == "Prediction ", df16$fdbk, NA)
df16$m_hist <- ifelse(df16$Screen == "Prediction ", df16$m_hist, NA)
df16$stress_level <- ifelse(df16$Screen == "Screen 12", df16$Response, NA)



long_df16 <- df16 %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE, stress_level) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE, stress_level),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df16 <- long_df16[!is.na(long_df16$Response), ]

# Selecting relevant columns from the original df16
df16 <- df16 %>%
  select(-c(fdbk, m_hist, PE, SubjPE, stress_level))

# Binding the rows together
df16 <- bind_rows(df16, long_df16)

df16$Response <- as.numeric(df16$Response)

# looking at the relationship between PE and SubjPE
df16_PE <- subset(df16, Screen == "PE")
names(df16_PE)[names(df16_PE) == "Screen"] <- "Screen_PE"
names(df16_PE)[names(df16_PE) == "Response"] <- "Response_PE"

df16_SubjPE <- subset(df16, Screen == "SubjPE")
names(df16_SubjPE)[names(df16_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df16_SubjPE)[names(df16_SubjPE) == "Response"] <- "Response_SubjPE"

df16_fdbk <- subset(df16, Screen == "fdbk")
names(df16_fdbk)[names(df16_fdbk) == "Screen"] <- "Screen_fdbk"
names(df16_fdbk)[names(df16_fdbk) == "Response"] <- "Response_fdbk"

df16_hist <- subset(df16, Screen == "m_hist")
names(df16_hist)[names(df16_hist) == "Screen"] <- "Screen_m_hist"
names(df16_hist)[names(df16_hist) == "Response"] <- "Response_m_hist"

df16_stress_level <- subset(df16, Screen == "Screen 12")
names(df16_stress_level)[names(df16_stress_level) == "Screen"] <- "Screen_stress_level"
names(df16_stress_level)[names(df16_stress_level) == "Response"] <- "Response_stress_level"

df16_predic <- subset(df16, Screen == "Prediction ")
names(df16_predic)[names(df16_predic) == "Screen"] <- "Screen_pred"
names(df16_predic)[names(df16_predic) == "Response"] <- "Response_pred"

df16_cert <- subset(df16, Screen == "Certainty rating ")
names(df16_cert)[names(df16_cert) == "Screen"] <- "Screen_certainty"
names(df16_cert)[names(df16_cert) == "Response"] <- "Response_certainty"

list_of_dfs_16 <- list(df16_PE, df16_fdbk, df16_hist, df16_predic, df16_cert, df16_SubjPE)

# Using reduce with inner_join
merged_df16 <- reduce(list_of_dfs_16, inner_join, by = c("Random_ID", "Trial.Number"))



df16_Anxious <- subset(df16, Screen == "Anxious")
names(df16_Anxious)[names(df16_Anxious) == "Screen"] <- "Screen_Ax"
names(df16_Anxious)[names(df16_Anxious) == "Response"] <- "Response_Ax"

df16_Happy <- subset(df16, Screen == "Happy")
# df16_fdbk <- subset(df16, Screen == "Prediction")
names(df16_Happy)[names(df16_Happy) == "Screen"] <- "Screen_H"
names(df16_Happy)[names(df16_Happy) == "Response"] <- "Response_H"

final_df16 <- merged_df16 %>%
  inner_join(df16_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df16_Happy, by = c("Random_ID", "Trial.Number"))


# subset only the columns we are interested in
final_df16 <- final_df16[c("Trial.Number", "Random_ID", "Response_H", "Response_Ax", "Response_fdbk", "Response_SubjPE", "Response_PE", "Response_certainty", "Response_m_hist", "Response_pred")]

final_df16 <- final_df16 %>%
  left_join(df16_spin %>% select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df16 <- final_df16 %>%
  left_join(df16_stress_level %>% select(Random_ID, Response_stress_level), by = "Random_ID")

final_df16 <- final_df16 %>%
  left_join(CESD_data_clean %>% select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df16$Social_Anxiety <- ifelse(final_df16$mini_SPIN_total >= 6, "high", "low")

write.csv(final_df16, "pilot_16_variables.csv", row.names = FALSE)

print("It seems everyone has done all the 48 trials, Elena managed to fix the issue some people were experiencing, possibly not seeing the next button. There is only 1 participant who did 46 trials due to an emergency from their side.") 
final_df16 %>%
  group_by(Random_ID) %>%
  summarise(Trial.Number = n())

write.csv(final_df16, "final_df16_with_stresslevels.csv", row.names = FALSE)
```

\newpage 
# Relationship between prediction and mean histogram

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_m_hist, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mean_hist and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_m_hist, y = Response_pred, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("prediction") + 
  ylab("mean_histogram") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) 
# +
#   ylim(c(0, 100)) + 
#   scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
#   xlim(c(-100, 100)) + 
#   scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between prediction and mean histogram across trials

I suspect to see a weaker correlation between prediction and mean of the histogram from first to last trial.

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df16 %>%
  group_by(Trial.Number) %>%
  summarise(correlation = cor(Response_m_hist, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mean_hist and prediction per trial:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_m_hist, y = Response_pred)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Trial.Number)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("prediction") + 
  ylab("mean_histogram") +
    facet_wrap(~ Trial.Number, scales = "free",ncol = 8) +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Trial.Number), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) 



correlations_with_groups <- final_df16 %>%
  mutate(Trial_Group = ifelse(Trial.Number >= 1 & Trial.Number <= 24, '1-24', 
                              ifelse(Trial.Number >= 25 & Trial.Number <= 48, '25-48', NA))) %>%
  group_by(Trial_Group) %>%
  summarise(correlation = cor(Response_m_hist, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))

average_correlations <- correlations_with_groups %>%
  group_by(Trial_Group) %>%
  summarise(average_correlation = mean(correlation, na.rm = TRUE))

# Printing the result
print(average_correlations)
  
```


\newpage 
# Relationship between Anxiety and SubjPE


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df16, aes(x = Response_SubjPE, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```

\newpage 
# Relationship between Mood and SubjPE


```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_SubjPE, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```

\newpage 
# Relationship between Mood and feedback

The relationship between mood and feedback still seems to be stronger than mood and subjective PE. Is this a problem? How do we even differentiate social reward, from social PE?

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Mfd <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Mfd$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_fdbk, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Mfd, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```



\newpage 
# Relationship between Mood and prediction

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_pred, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```


\newpage 
# Relationship between Anxiety and prediction

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_pred, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Anxiety and feedback

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df16 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df16, aes(x = Response_fdbk, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# trying to keep the BL_1 and BL_2 mood and anxiety ratings
df16_with_BL <- df16_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df16_with_BL <- df16_with_BL %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df16_with_BL$Screen <- ifelse(df16_with_BL$Trial.Number == 1 & (df16_with_BL$Display == "Mood " | df16_with_BL$Display == "Anxiety "), "BL_1",
                      ifelse(df16_with_BL$Trial.Number == 2 & (df16_with_BL$Display == "Mood " | df16_with_BL$Display == "Anxiety "), "BL_2", 
                             df16_with_BL$Screen))

df16_with_BL$m_hist <- ifelse(df16_with_BL$Spreadsheet..Histogram == "h1.png", 20,
                      ifelse(df16_with_BL$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(df16_with_BL$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(df16_with_BL$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(df16_with_BL$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(df16_with_BL$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df16_with_BL$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(df16_with_BL$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df16_with_BL <- df16_with_BL %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Anxiety ") |
      (Display == "Mood ")
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df16_with_BL$Trial.Number <- ifelse(df16_with_BL$Display == 'Mood ' | df16_with_BL$Display == 'Anxiety ', df16_with_BL$Trial.Number - 2, df16_with_BL$Trial.Number)
# df16_with_BL$Display <- ifelse(df16_with_BL$Display == 'Mood ' | df16_with_BL$Display == 'Anxiety ', "Trials", df16_with_BL$Display)

final_df16_with_BL <- df16_with_BL[c("Trial.Number", "Display", "Screen", "Response", "Random_ID")]

final_df16_with_BL <- final_df16_with_BL %>%
  left_join(df16_spin %>% select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df16_with_BL <- final_df16_with_BL %>%
  left_join(CESD_data_clean %>% select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df16_with_BL$Social_Anxiety <- ifelse(final_df16_with_BL$mini_SPIN_total >= 6, "high", "low")
```



\newpage 
# Mood over time 


```{r echo=FALSE, warning=FALSE, message=FALSE}
df16_BL_ax <- subset(final_df16_with_BL, Display == "Anxiety ")
df16_BL_H <- subset(final_df16_with_BL,Display == "Mood ")

ggplot(df16_BL_H, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Mood across time",
       x = "Trial Number",
       y = "Mood",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Anxiety over time 
```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(df16_BL_ax, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Anxiety across time",
       x = "Trial Number",
       y = "Anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


\newpage
# LME models for Mood and SubjPE

When looking at subjective PE, the best model is  Mood ~ SubjPE + (SubjPE | Random_ID) with an AIC of 19784.67
When including feedback the best model is Mood ~ feedback  + (feedback | Random_ID) with an AIC of 19380.41
```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_H ~ Response_SubjPE + (1 | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_H ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model2a <- lme4::lmer(Response_H ~ Response_SubjPE + Response_fdbk + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))

AIC(model2)
AIC(model2a)

summary(model2)
summary(model2a)
anova(model2, model2a)

standard_beta_m2 <- parameters:: standardise_parameters (model2)
standard_beta_m2a <- parameters:: standardise_parameters (model2a)


model1 <- lme4::lmer(Response_H ~ Response_SubjPE + (1 | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_H ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_H ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))

model4 <- lme4::lmer(Response_H ~ Response_fdbk + (1 | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model5 <- lme4::lmer(Response_H ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model6 <- lme4::lmer(Response_H ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))

print("Model 1 summary: Response_H ~ Response_SubjPE + (1 | Random_ID)")
summary(model1)

print("Model 2 summary: Response_H ~ Response_SubjPE + (Response_SubjPE | Random_ID)")
summary(model2)

print("Model 3 summary: Response_H ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID) ")
summary(model3)

print("Model 4 summary: Response_H ~ Response_fdbk + (1 | Random_ID)")
summary(model4)

print("Model 5 summary: Response_H ~ Response_fdbk + (Response_fdbk | Random_ID)")
summary(model5)

print("Model 6 summary: Response_H ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID)")
summary(model6)

print("AIC model1:")
AIC(model1)
print("AIC model2:")
AIC(model2)
print("AIC model3:")
AIC(model3)
print("AIC model4:")
AIC(model4)
print("AIC model5:")
AIC(model5)
print("AIC model6:")
AIC(model6)

# anova(model2, model5)
# coef_fixed <- fixef(model3)
# intercept_Mood <- coef_fixed[1]
# slope_Mood <- coef_fixed[2]
# standard_beta_fdbk <- parameters:: standardise_parameters (model5)
# standard_beta_subjPE <- parameters:: standardise_parameters (model2)
# test <- model5 %>% broom.mixed::tidy("fixed") 
```

\newpage 
# Individual plots with LME for Mood with SubjPE
When looking at subjective PE, the best model is  Mood ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 19784.67

```{r echo=FALSE, warning=FALSE, message=FALSE}

coef_fixed <- fixef(model2)
intercept_Mood <- coef_fixed[1]
slope_Mood <- coef_fixed[2]
standard_beta_subjPE <- parameters:: standardise_parameters (model2)

ggplot(final_df16, aes(x=Response_SubjPE, y=Response_H)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Subjective PE") + 
  ylab("Mood") +
  ggtitle("Relationship between Mood and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

p16_m <- ggplot(final_df16, aes(x=Response_SubjPE, y=Response_H)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Subjective PE") + 
  ylab("Mood") +
  ggtitle("Relationship between Mood and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

ggsave(filename = "p16_m.png", plot = p16_m, dpi = 300, width = 6, height = 4)
```


\newpage 
# Individual plots with LME for Mood with feedback instead of SubjPE

When including feedback the best model is Mood ~ feedback  + (feedback | Random_ID) with an AIC of 19380.41

```{r echo=FALSE, warning=FALSE, message=FALSE}
coef_fixed <- fixef(model5)
intercept_Mood <- coef_fixed[1]
slope_Mood <- coef_fixed[2]
standard_beta_fdbk <- parameters:: standardise_parameters (model5)


ggplot(final_df16, aes(x=Response_fdbk, y=Response_H)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Feedback") + 
  ylab("Mood") +
  ggtitle("Relationship between Mood and Feedback",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_fdbk$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_fdbk$CI_low[2],2), "-", 
                                                 round(standard_beta_fdbk$CI_high[2],2))) 
  
```

\newpage
# LME models for Anxiety and SubjPE

When looking at subjective PE, the best model is  Anxiety ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 19691.4
When including feedback the best model is Anxiety ~ feedback  + (Random_ID) with an AIC of 19530.9

```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_Ax ~ Response_SubjPE + (1 | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_Ax ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_Ax ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))

model4 <- lme4::lmer(Response_Ax ~ Response_fdbk + (1 | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model5 <- lme4::lmer(Response_Ax ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))
model6 <- lme4::lmer(Response_Ax ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df16, control=lmerControl(optimizer="bobyqa"))

print("Model 1 summary: Response_Ax ~ Response_SubjPE + (1 | Random_ID)")
summary(model1)

print("Model 2 summary: Response_Ax ~ Response_SubjPE + (Response_SubjPE | Random_ID)")
summary(model2)

print("Model 3 summary: Response_Ax ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID) ")
summary(model3)

print("Model 4 summary: Response_Ax ~ Response_fdbk + (1 | Random_ID)")
summary(model4)

print("Model 5 summary: Response_Ax ~ Response_fdbk + (Response_fdbk | Random_ID)")
summary(model5)

print("Model 6 summary: Response_Ax ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID)")
summary(model6)

print("AIC model1:")
AIC(model1)
print("AIC model2:")
AIC(model2)
print("AIC model3:")
AIC(model3)
print("AIC model4:")
AIC(model4)
print("AIC model5:")
AIC(model5)
print("AIC model6:")
AIC(model6)

# anova(model2, model5)

coef_fixed_subjPE <- fixef(model2)
intercept_ax_subjPE <- coef_fixed[1]
slope_ax_subjPE <- coef_fixed[2]
standard_beta_fdbk <- parameters:: standardise_parameters (model2)

coef_fixed_fdbk <- fixef(model5)
intercept_ax_fdbk <- coef_fixed[1]
slope_ax_fdbk <- coef_fixed[2]
standard_beta_subjPE <- parameters:: standardise_parameters (model5)
```


\newpage 
# Individual plots with LME for Anxiety with SubjPE
When looking at subjective PE, the best model is  Anxiety ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 19691.4

```{r echo=FALSE, warning=FALSE, message=FALSE}

coef_fixed <- fixef(model2)
intercept_ax <- coef_fixed[1]
slope_ax <- coef_fixed[2]
standard_beta_subjPE <- parameters:: standardise_parameters (model2)


ggplot(final_df16, aes(x=Response_SubjPE, y=Response_Ax)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_ax, slope = slope_ax, color="purple", linetype="dashed", size=1) +
  xlab("Subjective PE") + 
  ylab("Anxiety") +
  ggtitle("Relationship between Anxiety and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

p16_ax <- ggplot(final_df16, aes(x=Response_SubjPE, y=Response_Ax)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_ax, slope = slope_ax, color="purple", linetype="dashed", size=1) +
  xlab("Subjective PE") + 
  ylab("Anxiety") +
  ggtitle("Relationship between Anxiety and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

ggsave(filename = "p16_ax.png", plot = p16_ax, dpi = 300, width = 6, height = 4)
  
```


\newpage 
# Individual plots with LME for Anxiety with feedback instead of SubjPE

When including feedback the best model is Anxiety ~ feedback  + (Random_ID) with an AIC of 8761.136

```{r echo=FALSE, warning=FALSE, message=FALSE}

coef_fixed <- fixef(model5)
intercept_ax <- coef_fixed[1]
slope_ax <- coef_fixed[2]
standard_beta_fdbk <- parameters:: standardise_parameters (model5)


ggplot(final_df16, aes(x=Response_fdbk, y=Response_Ax)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_ax, slope = slope_ax, color="purple", linetype="dashed", size=1) +
  xlab("Feedback") + 
  ylab("Anxiety") +
  ggtitle("Relationship between Anxiety and Feedback",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df16$Random_ID))))+
  theme(plot.title = element_text(size=16), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_fdbk$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_fdbk$CI_low[2],2), "-", 
                                                 round(standard_beta_fdbk$CI_high[2],2))) 
  
```

\newpage
# Relationship average anxiety on the task and how stressful they rated the task

We have only one scale at the end when asking feedback, and we ask them "How stressful was this as a social situation?" on a scale of 0-100. Let's look at the relationshio between this score and anxiety on the task, but also the average score in people with high and low social anxiety.

```{r echo=FALSE, warning=FALSE, message=FALSE}

filter_final_df16 <- subset(final_df16, final_df16$Trial.Number == 1)

high <- filter_final_df16[filter_final_df16$Social_Anxiety == "high", ]$Response_stress_level
low <- filter_final_df16[filter_final_df16$Social_Anxiety == "low", ]$Response_stress_level

shapiro_test_high <- shapiro.test(high)
shapiro_test_low <- shapiro.test(low)

if (shapiro_test_high$p.value <= 0.05 || shapiro_test_low$p.value <= 0.05) {
  # At least one group is not normally distributed, use Mann-Whitney U test
  mw_test_result <- wilcox.test(high, low)
  print(mw_test_result)
}



ggplot(filter_final_df16, aes(x = Social_Anxiety, y = Response_stress_level , fill = Social_Anxiety)) +
  geom_boxplot(outlier.colour = "black") +
  stat_boxplot(geom = "errorbar",
               width = 0.15) + 
  geom_point(color = "black", position = position_jitter(width = 0.2), alpha = 0.7) +
  theme_minimal() +
  # labs(x = "Display", y = "Response") +
  # scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  # ggtitle("Average anxiety ratings in pilots 1 and 2 in socially anxious people") +
  xlab("") + 
  ylab("stress levels (0-10)") +
  # facet_wrap(~group, scales = "free", ncol = 4) +
  # scale_fill_manual(values = c("black", "purple", "darkgreen", "blue"))+
  # ylim(c(50, 100)) + 
  # scale_y_continuous(breaks = seq(50, 100, by = 10), limits = c(50, 100))+
  theme(
    panel.grid.major = element_blank(),  # Removes major grid lines
    panel.grid.minor = element_blank(),  # Removes minor grid lines
    panel.border = element_blank(),      # Removes the border line
    axis.line = element_blank(),          # Removes axis lines
    plot.background = element_rect(fill = "white", colour = NA)   # Ensure plot background is white
  )

```






\newpage
# Bayesian LME

```{r echo=FALSE, warning=FALSE, message=FALSE}
# library(brms)
# # Prefer ar from the stats package
# conflicts_prefer(stats::ar)
# conflicts_prefer(Matrix::expand)
# conflicts_prefer(dplyr::filter)
# conflicts_prefer(dplyr::lag)
# conflicts_prefer(brms::ngrps)
# conflicts_prefer(tidyr::pack)
# conflicts_prefer(tidyr::unpack)
# 
# # Define prior distributions for the parameters
# prior <- c(
#   prior(normal(0, 10), "b"), # Priors for the fixed effects coefficients
#   prior(student_t(5, 0, 10), "sd"), # Priors for the standard deviations of the random effects
#   prior(lkj(2), "cor") # Prior for the correlation of the random effects
# )
# 
# # Fit the Bayesian LME model
# bayesian_model <- brm(
#   formula = Response_Ax ~ Response_SubjPE + (Response_SubjPE | Random_ID),
#   data = final_df16,
#   family = gaussian(), # Assuming a Gaussian family, adjust if necessary
#   prior = prior,
#   control = list(optimizer = "bobyqa"),
#   warmup = 1000, # Number of warmup iterations for the MCMC
#   iter = 4000, # Total number of iterations for the MCMC
#   chains = 4, # Number of chains
#   core = parallel::detectCores(), # Use multiple cores for faster computation
#   seed = 123 # For reproducibility
# )
# 
# # Inspect the model output
# summary(bayesian_model)


# correlations <- final_df16 %>%
#   group_by(Random_ID) %>%
#   summarise(correlation = cor(Response_m_hist, Response_pred, use = "complete.obs")) %>%
#   mutate(label = paste("R = ", round(correlation, digits = 2)))

```

