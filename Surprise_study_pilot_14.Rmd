---
title: "Surprise study pilot 14"
author: "Marjan Biria"
date: "2024-02-07"
output: 
    pdf_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lme4)
library(parameters)
library(broom.mixed)
library(purrr)
library(conflicted)
library(stringr)
library(readxl)
```


\newpage
# Study description

This study has the same version of PE's as pilots 10 and 11, also having video and audio only. In this pilot we 1) replaced the judge pictures with cartoon images to see whether it becomes more believable as many people believed those images were AI generated, 2) we allow participants to also choose their own avatar, again to make it more believable that the others are also real, 3) we have created a new narrative around public speaking and what is the goal of this task and added criteria they will be judged open to make them more nervous but also make it more believable if they get a rating that they cannot guess what they were judged upon at each trial (they are told the judges will receive a new criterion per trial), 4) lastly, we changed two feedback questions to inquire about believability, one of them being a scale asking "How stressful was this as a social situation?"

The Gorilla experiment is the following: https://app.gorilla.sc/admin/project/120255
The task is the following: https://app.gorilla.sc/admin/task/741126/editor?version=13

I will write this here as well for us to have, if we forget again:  
**Positive PE:** we selected numbers from a normal distribution ranging from 12-20, added this number to the mean of the histogram.  
**Negative PE:** we selected numbers from a normal distribution ranging from 12-20, subtracted this number to the mean of the histogram.  
**Big positive PE:** Per judge, we added 10 to the biggest positive feedback we had generated before.  
**Neutral PE: ** we added -1, 0, 1 to the mean of the histograms  

In this sample, only 17 people out of 41 had high social anxiety.


```{r echo=FALSE, warning=FALSE, message=FALSE}
# the path to be changed to the original folder after stress levels are extracted:
df14_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr1_avatars/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9_task_main.csv")
df14_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr1_avatars/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9_mini_spin.csv")
df14_cesd <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_vid_big_PE_narr1_avatars/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9/SUP_PRF_pilot_vid_big_PE_narr1_avatars_v9_ces_d.csv")
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# extract CES-D scores
CESD_data_clean <- df14_cesd[, c(32, 34, 36, 38, 40, 42, 44, 46,48,50,
                                 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 71 )]
# Identify non-ID variable columns
non_id_cols <- setdiff(names(CESD_data_clean), "Random_ID")

# Convert non-ID variables to numeric
CESD_data_clean[, non_id_cols] <- lapply(CESD_data_clean[, non_id_cols], as.numeric)

#change numbers to match CES-D scoring system
excluded_columns <-  c("Random_ID", "Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                       "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                       "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                       "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")


CESD_data_clean<- CESD_data_clean %>%
  mutate(across(-excluded_columns , ~ case_when(
    . == 1 ~ 0,
    . == 2 ~ 1,
    . == 3 ~ 2,
    . == 4 ~ 3,
    TRUE ~ .
  )))


other_columns <- c("Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
                   "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
                   "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
                   "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
CESD_data_clean<- CESD_data_clean %>%
  mutate(across(other_columns , ~ case_when(
    . == 1 ~ 3,
    . == 2 ~ 2,
    . == 3 ~ 1,
    . == 4 ~ 0,
    TRUE ~ .
  )))

#scoring----
CESD_scores <-  numeric(length(CESD_data_clean$Random_ID))
CESD_scores <- 0
Questions <- c(1:20)

for (i in 1:nrow(CESD_data_clean)) {
  CESD_score <- sum(CESD_data_clean[i, Questions])
  CESD_scores[i] <- CESD_score
}

CESD_data_clean$CESD_score <-  CESD_scores

CESD_data_clean$Depression_Threshold<- 0
CESD_data_clean$Depression_status <- "Not_Depressed"

#Assign "1" if they meet Depression threshold 
for (i in 1:nrow(CESD_data_clean)) {
  if (CESD_data_clean$CESD_score[i] >= 16) {
    CESD_data_clean$Depression_Threshold[i] <- 1
    CESD_data_clean$Depression_status[i] <- "Depressed"
  }
}
```


```{r echo=FALSE, warning=FALSE, message=FALSE}


df14_spin <- df14_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears."
  )

df14_spin <- df14_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()


# create a new df14 that only keeps the columns we need
df14 <- df14_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df14 <- df14 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df14$Screen <- ifelse(df14$Trial.Number == 1 & (df14$Display == "Mood " | df14$Display == "Anxiety "), "BL_1",
                      ifelse(df14$Trial.Number == 2 & (df14$Display == "Mood " | df14$Display == "Anxiety "), "BL_2", 
                             df14$Screen))

df14$m_hist <- ifelse(df14$Spreadsheet..Histogram == "h1.png", 20,
                      ifelse(df14$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(df14$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(df14$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(df14$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(df14$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df14$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(df14$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df14 <- df14 %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Exit") |
      (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
      (Display == "Mood " & !Trial.Number %in% c(1, 2))
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df14$Trial.Number <- ifelse(df14$Display == 'Mood ' | df14$Display == 'Anxiety ', df14$Trial.Number - 2, df14$Trial.Number)
df14$Display <- ifelse(df14$Display == 'Mood ' | df14$Display == 'Anxiety ', "Trials", df14$Display)

# renaming the feedback column to fdbk
names(df14)[names(df14) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df14$SubjPE <- ifelse(df14$Screen == "Prediction ", df14$fdbk - df14$Response, NA)
df14$PE <- ifelse(df14$Screen == "Prediction ", df14$fdbk - df14$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df14$fdbk <- ifelse(df14$Screen == "Prediction ", df14$fdbk, NA)
df14$m_hist <- ifelse(df14$Screen == "Prediction ", df14$m_hist, NA)
df14$stress_level <- ifelse(df14$Screen == "Screen 12", df14$Response, NA)

long_df14 <- df14 %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE, stress_level) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE, stress_level),
               names_to = "Screen",
               values_to = "Response")

# This will keep only the rows where 'Response' is not NA
long_df14 <- long_df14[!is.na(long_df14$Response), ]

# Selecting relevant columns from the original df14
df14 <- df14 %>%
  select(-c(fdbk, m_hist, PE, SubjPE, stress_level))

# Binding the rows together
df14 <- bind_rows(df14, long_df14)

df14$Response <- as.numeric(df14$Response)

# looking at the relationship between PE and SubjPE
df14_PE <- subset(df14, Screen == "PE")
names(df14_PE)[names(df14_PE) == "Screen"] <- "Screen_PE"
names(df14_PE)[names(df14_PE) == "Response"] <- "Response_PE"

df14_SubjPE <- subset(df14, Screen == "SubjPE")
names(df14_SubjPE)[names(df14_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df14_SubjPE)[names(df14_SubjPE) == "Response"] <- "Response_SubjPE"

df14_fdbk <- subset(df14, Screen == "fdbk")
names(df14_fdbk)[names(df14_fdbk) == "Screen"] <- "Screen_fdbk"
names(df14_fdbk)[names(df14_fdbk) == "Response"] <- "Response_fdbk"

df14_hist <- subset(df14, Screen == "m_hist")
names(df14_hist)[names(df14_hist) == "Screen"] <- "Screen_m_hist"
names(df14_hist)[names(df14_hist) == "Response"] <- "Response_m_hist"

df14_stress_level <- subset(df14, Screen == "Screen 12")
names(df14_stress_level)[names(df14_stress_level) == "Screen"] <- "Screen_stress_level"
names(df14_stress_level)[names(df14_stress_level) == "Response"] <- "Response_stress_level"

df14_predic <- subset(df14, Screen == "Prediction ")
names(df14_predic)[names(df14_predic) == "Screen"] <- "Screen_pred"
names(df14_predic)[names(df14_predic) == "Response"] <- "Response_pred"

df14_cert <- subset(df14, Screen == "Certainty rating ")
names(df14_cert)[names(df14_cert) == "Screen"] <- "Screen_certainty"
names(df14_cert)[names(df14_cert) == "Response"] <- "Response_certainty"

list_of_dfs_14 <- list(df14_PE, df14_fdbk, df14_hist, df14_predic, df14_cert, df14_SubjPE)

# Using reduce with inner_join
merged_df14 <- reduce(list_of_dfs_14, inner_join, by = c("Random_ID", "Trial.Number"))

df14_Anxious <- subset(df14, Screen == "Anxious")
names(df14_Anxious)[names(df14_Anxious) == "Screen"] <- "Screen_Ax"
names(df14_Anxious)[names(df14_Anxious) == "Response"] <- "Response_Ax"

df14_Happy <- subset(df14, Screen == "Happy")
# df14_fdbk <- subset(df14, Screen == "Prediction")
names(df14_Happy)[names(df14_Happy) == "Screen"] <- "Screen_H"
names(df14_Happy)[names(df14_Happy) == "Response"] <- "Response_H"

final_df14 <- merged_df14 %>%
  inner_join(df14_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df14_Happy, by = c("Random_ID", "Trial.Number"))


# subset only the columns we are interested in
final_df14 <- final_df14[c("Trial.Number", "Random_ID", "Response_H", "Response_Ax", "Response_fdbk", "Response_SubjPE", "Response_PE", "Response_certainty", "Response_m_hist", "Response_pred")]

final_df14 <- final_df14 %>%
  left_join(df14_spin %>% select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df14 <- final_df14 %>%
  left_join(df14_stress_level %>% select(Random_ID, Response_stress_level), by = "Random_ID")

final_df14 <- final_df14 %>%
  left_join(CESD_data_clean %>% select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df14$Social_Anxiety <- ifelse(final_df14$mini_SPIN_total >= 6, "high", "low")

# write.csv(final_df14, "pilot_14_variables.csv", row.names = FALSE)

final_df14 %>%
  group_by(Random_ID) %>%
  summarise(Trial.Number = n())

# write.csv(final_df14, "final_df14_with_stresslevels.csv", row.names = FALSE)

```

\newpage 
# Relationship between Anxiety and SubjPE


```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df14, aes(x = Response_SubjPE, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```

\newpage 
# Relationship between Mood and SubjPE


```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE:", average_correlation)

print(message_to_print_H)

ggplot(final_df14, aes(x = Response_SubjPE, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```

\newpage 
# Relationship between Mood and feedback

The relationship between mood and feedback seems to be stronger than mood and subjective PE (0.24 vs 0.17), so it seems people may care more about the feedback as receiving reward or punishment, rather than social PE? The relationship between subjective PE with both anxiety and mood has been the weakest across all pilots. We need to make sure it is only because of changing the pictures of virtual players, maybe by changing the narrative they would assume that the other players are also learning how to do public speaking (less intimidating than someone who is an expert?).

To be sure, I wonder if we want to repeat the pilot and just replace the images?

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Mfd <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Mfd$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df14, aes(x = Response_fdbk, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Mfd, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```



\newpage 
# Relationship between Mood and prediction

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df14, aes(x = Response_pred, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```


\newpage 
# Relationship between Anxiety and prediction

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_pred, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df14, aes(x = Response_pred, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```

\newpage 
# Relationship between Anxiety and feedback

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df14 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_fdbk, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between anxiety and feedback:", average_correlation)

print(message_to_print_H)

ggplot(final_df14, aes(x = Response_fdbk, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(0, 100, by = 25), limits = c(0,100))
  
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# trying to keep the BL_1 and BL_2 mood and anxiety ratings
df14_with_BL <- df14_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

df14_with_BL <- df14_with_BL %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df14_with_BL$Screen <- ifelse(df14_with_BL$Trial.Number == 1 & (df14_with_BL$Display == "Mood " | df14_with_BL$Display == "Anxiety "), "BL_1",
                      ifelse(df14_with_BL$Trial.Number == 2 & (df14_with_BL$Display == "Mood " | df14_with_BL$Display == "Anxiety "), "BL_2", 
                             df14_with_BL$Screen))

df14_with_BL$m_hist <- ifelse(df14_with_BL$Spreadsheet..Histogram == "h1.png", 20,
                      ifelse(df14_with_BL$Spreadsheet..Histogram == "h2.png", 212,
                             ifelse(df14_with_BL$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(df14_with_BL$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(df14_with_BL$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(df14_with_BL$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(df14_with_BL$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(df14_with_BL$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df14_with_BL <- df14_with_BL %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Anxiety ") |
      (Display == "Mood ")
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df14_with_BL$Trial.Number <- ifelse(df14_with_BL$Display == 'Mood ' | df14_with_BL$Display == 'Anxiety ', df14_with_BL$Trial.Number - 2, df14_with_BL$Trial.Number)
# df14_with_BL$Display <- ifelse(df14_with_BL$Display == 'Mood ' | df14_with_BL$Display == 'Anxiety ', "Trials", df14_with_BL$Display)

final_df14_with_BL <- df14_with_BL[c("Trial.Number", "Display", "Screen", "Response", "Random_ID")]

final_df14_with_BL <- final_df14_with_BL %>%
  left_join(df14_spin %>% select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df14_with_BL <- final_df14_with_BL %>%
  left_join(CESD_data_clean %>% select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df14_with_BL$Social_Anxiety <- ifelse(final_df14_with_BL$mini_SPIN_total >= 6, "high", "low")
```



\newpage 
# Mood over time 


```{r echo=FALSE, warning=FALSE, message=FALSE}
df14_BL_ax <- subset(final_df14_with_BL, Display == "Anxiety ")
df14_BL_H <- subset(final_df14_with_BL,Display == "Mood ")

ggplot(df14_BL_H, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Mood across time",
       x = "Trial Number",
       y = "Mood",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Anxiety over time 
```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(df14_BL_ax, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Anxiety across time",
       x = "Trial Number",
       y = "Anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```



\newpage
# Participants' feedback
In the feedback we received from people, some people mentioned they did not like being watched and some mentioned since they did not see the other person, they did not care and did not think they were real and did not influence how they felt. We did have a few people who mentioned "the observer" or "they" when trying to descrive the virtual players. But overall, seeing how weaker the relationship is, I don't think having the cartoon images helps.  

But since in this new pilot we have had several changes at once, shall we repeat the pilot with the new narrative but with the old pictures we had?


\newpage 
# Anxiety- SubjPE correlations
```{r echo=FALSE, warning=FALSE, message=FALSE}
# avatar_feedback <- read.csv("avatar_pilot_task_with_feedback.csv")
# avatar_feedback <- dplyr::filter(avatar_feedback, Screen.ID == "tuhtwy" & Response.Type == "response")
# correlations_Ax_merged <- merge(correlations_Ax, avatar_feedback[, c("Random_ID", "Thought_avatars_real")], by = "Random_ID", all.x = TRUE)
# 
# correlations_Ax_summary <- correlations_Ax_merged %>%
# group_by(Thought_avatars_real) %>%
# summarize(mean_correlation = mean(correlation,na.rm = TRUE),
#             sample_size = n())
# 
# print(correlations_Ax_summary)
```

\newpage 
# Anxiety- Feedback correlations
If we wanted to run this again, we need the file "avatar_pilot_task_with_feedback.csv" which Elena has but since it has identifiable data we have not put it on Github.
```{r echo=FALSE, warning=FALSE, message=FALSE}
# avatar_feedback <- read.csv("avatar_pilot_task_with_feedback.csv")
# avatar_feedback <- dplyr::filter(avatar_feedback, Screen.ID == "tuhtwy" & Response.Type == "response")
# correlations_merged <- merge(correlations, avatar_feedback[, c("Random_ID", "Thought_avatars_real")], by = "Random_ID", all.x = TRUE)
# 
# correlations_summary <- correlations_merged %>%
# group_by(Thought_avatars_real) %>%
# summarize(mean_correlation = mean(correlation,na.rm = TRUE),
#             sample_size = n())

# print(correlations_summary)
```

\newpage 
# Mood - SubjPE correlations
```{r echo=FALSE, warning=FALSE, message=FALSE}
# avatar_feedback <- read.csv("avatar_pilot_task_with_feedback.csv")
# avatar_feedback <- dplyr::filter(avatar_feedback, Screen.ID == "tuhtwy" & Response.Type == "response")
# correlations_M_merged <- merge(correlations_M, avatar_feedback[, c("Random_ID", "Thought_avatars_real")], by = "Random_ID", all.x = TRUE)
# 
# correlations_M_summary <- correlations_M_merged %>%
# group_by(Thought_avatars_real) %>%
# summarize(mean_correlation = mean(correlation,na.rm = TRUE),
#             sample_size = n())
# 
# print(correlations_M_summary)
```

\newpage 
# Mood-Feedback correlations
```{r echo=FALSE, warning=FALSE, message=FALSE}
# avatar_feedback <- read.csv("avatar_pilot_task_with_feedback.csv")
# avatar_feedback <- dplyr::filter(avatar_feedback, Screen.ID == "tuhtwy" & Response.Type == "response")
# correlations_Mfd_merged <- merge(correlations_Mfd, avatar_feedback[, c("Random_ID", "Thought_avatars_real")], by = "Random_ID", all.x = TRUE)
# 
# correlations_Mfd_summary <- correlations_Mfd_merged %>%
# group_by(Thought_avatars_real) %>%
# summarize(mean_correlation = mean(correlation,na.rm = TRUE),
#             sample_size = n())
# 
# print(correlations_Mfd_summary)
```

\newpage
# LME models for Mood and SubjPE
I will now look at the best LME models including feedback as well. But since subjective PE does include feedback, I will either only include feedback or SubjPE.

When looking at subjective PE, the best model is  Mood ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 16192.33
When including feedback the best model is Mood ~ feedback  + (feedback | Random_ID) with an AIC of 16014.14
```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_H ~ Response_SubjPE + (1 | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_H ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_H ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))

model4 <- lme4::lmer(Response_H ~ Response_fdbk + (1 | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model5 <- lme4::lmer(Response_H ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model6 <- lme4::lmer(Response_H ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))

summary(model1)
summary(model2)
summary(model3)
summary(model4)
summary(model5)
summary(model6)

AIC(model1)
AIC(model2)
AIC(model3)
AIC(model4)
AIC(model5)
AIC(model6)

# anova(model2, model5)

coef_fixed <- fixef(model5)
intercept_Mood <- coef_fixed[1]
slope_Mood <- coef_fixed[2]
standard_beta_fdbk <- parameters:: standardise_parameters (model5)
standard_beta_subjPE <- parameters:: standardise_parameters (model2)
# test <- model5 %>% broom.mixed::tidy("fixed") 
```

\newpage 
# Individual plots with LME for Mood with SubjPE
When looking at subjective PE, the best model is  Mood ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 16192.33

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(final_df14, aes(x=Response_SubjPE, y=Response_H)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("SubjPE") + 
  ylab("Mood") +
  ggtitle("Relationship between Mood and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df14$Random_ID))))+
  theme(plot.title = element_text(size=14), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

# ggsave(filename = "p14_m.png", plot = p14_m, dpi = 300, width = 6, height = 4)
  
```


\newpage 
# Individual plots with LME for Mood with feedback instead of SubjPE

When including feedback the best model is Mood ~ feedback  + (feedback | Random_ID) with an AIC of 16014.14

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(final_df14, aes(x=Response_fdbk, y=Response_H)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Feedback") + 
  ylab("Mood") +
  ggtitle("Relationship between Mood and Feedback",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df14$Random_ID))))+
  theme(plot.title = element_text(size=14), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_fdbk$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_fdbk$CI_low[2],2), "-", 
                                                 round(standard_beta_fdbk$CI_high[2],2))) 
  
```

\newpage
# LME models for Anxiety and SubjPE

When looking at subjective PE, the best model is  Anxiety ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 16097.78
When including feedback the best model is Anxiety ~ feedback  + (Random_ID) with an AIC of 16084.09

```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_Ax ~ Response_SubjPE + (1 | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_Ax ~ Response_SubjPE + (Response_SubjPE | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_Ax ~ Response_SubjPE * mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))

model4 <- lme4::lmer(Response_Ax ~ Response_fdbk + (1 | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model5 <- lme4::lmer(Response_Ax ~ Response_fdbk + (Response_fdbk | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))
model6 <- lme4::lmer(Response_Ax ~ Response_fdbk * mini_SPIN_total + (Response_fdbk | Random_ID), data = final_df14, control=lmerControl(optimizer="bobyqa"))

summary(model1)
summary(model2)
summary(model3)
summary(model4)
summary(model5)
summary(model6)

AIC(model1)
AIC(model2)
AIC(model3)
AIC(model4)
AIC(model5)
AIC(model6)

# anova(model2, model5)

coef_fixed <- fixef(model2)
intercept_Mood <- coef_fixed[1]
slope_Mood <- coef_fixed[2]
standard_beta_fdbk <- parameters:: standardise_parameters (model4)
standard_beta_subjPE <- parameters:: standardise_parameters (model2)
```


\newpage 
# Individual plots with LME for Anxiety with SubjPE
When looking at subjective PE, the best model is  Anxiety ~ SubjPE  + (SubjPE | Random_ID) with an AIC of 16097.78

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(final_df14, aes(x=Response_SubjPE, y=Response_Ax)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Subjective PE") + 
  ylab("Anxiety") +
  ggtitle("Relationship between Anxiety and subjective PE",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df14$Random_ID))))+
  theme(plot.title = element_text(size=14), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_subjPE$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_subjPE$CI_low[2],2), "-", 
                                                 round(standard_beta_subjPE$CI_high[2],2))) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  scale_x_continuous(breaks = seq(-80, 80, by = 40), limits = c(-80, 80))

# ggsave(filename = "p14_ax.png", plot = p14_ax, dpi = 300, width = 6, height = 4)
  
```


\newpage 
# Individual plots with LME for Anxiety with feedback instead of SubjPE

When including feedback the best model is Anxiety ~ feedback  + (Random_ID) with an AIC of 16084.09

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(final_df14, aes(x=Response_fdbk, y=Response_Ax)) +
  geom_smooth(method = "lm", size = 0.5, se = FALSE, aes(group=Random_ID, color=Social_Anxiety)) +
  scale_color_manual(values = c("low" = "lightblue", "high" = "pink")) +
  geom_abline(intercept = intercept_Mood, slope = slope_Mood, color="purple", linetype="dashed", size=1) +
  xlab("Feedback") + 
  ylab("Mood") +
  ggtitle("Relationship between Anxiety and Feedback",
          subtitle = paste("estimated slopes of the association in n = ", 
                           length(unique(final_df14$Random_ID))))+
  theme(plot.title = element_text(size=14), plot.subtitle = element_text(size = 10))+
  theme(legend.title = element_text(size = 9), legend.text = element_text(size = 8))+
  theme(axis.title = element_text(size = 10))+
  annotate("label", x = 32, y = 55, label = paste("beta = ", round(standard_beta_fdbk$Std_Coefficient[2],2), ", 95%CI = ",
                                                 round(standard_beta_fdbk$CI_low[2],2), "-", 
                                                 round(standard_beta_fdbk$CI_high[2],2))) 
  
```

\newpage 
# ICC for anxiety

we will now look at the ICC outcome for anxiety
<br> The ICC for anxiety is 0.75, which is moderate/good according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(irr)
library(lme4)
library(psych)

# change name to model null (same for all others)
model <- lme4::lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df14)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```


\newpage 
# ICC for mood 

The ICC for mood is 0.42, which is lower than anxiety and is actually  within the poor category, according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
# change name to model null (same for all others)
model <- lme4::lmer(Response_H ~ 1 + (1 | Random_ID), data = final_df14)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for mood with just the intercept")
print(icc)

confint(model)
```