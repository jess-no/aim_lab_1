---
output: pdf_document
pdf_document: default
---
<br>
<br>

---
author: "Marjan biria"
output: github_document
---

<br><br>

## Surprise study 
<br>
This file contains all the analyses used for the different versions of the surprise task and pilots. <br> <br>

#### Pilot 1 (face/emotion rating) : to be added <br>
**Goal:** to find faces that seem crticial/easy-going to most people which then would be used in the main task to induce expectation. We tested whether neutral faces can be observed to be more critical compared to happy faces. We also did another analysis selecting the most crticial faces (need to ask Elena for this data as it was completed while I was on AL). 
Platform: Testable_Minds, Prolific
<br><br>

#### Pilot 2 (feedback statements using videos): to be added <br>
**Goal:** to collect statements that can be used to provide feedback that is either neutral or positive.
We collected statements from participants after they watched a video of someone doing the same task (describing a picture). Initially not successful, however, after changing the instructions to provide examples of positive and neutral statements the quality of statements we received improved. 
Platform: Testable_Minds, Prolific
<br><br>

#### Pilot 3 (feedback statements using 2 lists): to be added <br>
**Goal:** to collect statements that can be used to provide feedback that is either neutral or positive, as pilot 2 had not been very successful at first.We generated two lists of statements using CHATGPT3 and asked participants to choose which one makes them feel more confident (presenting only 2 options at a time). 
Platform: Testable_Minds, Prolific
<br><br>


#### Pilot 4: prediction + no feedback (to test whether histograms can induce expectation)
<br> 
**Goal:**This was a pilot to test whether or not histograms can induce expectation. 
The following data was collected on Prolific. The first section looks at the relationship between histogram mean with the  participant's expectation. In this version of the task participants did not receive any feedback: https://app.gorilla.sc/admin/experiment/142855/design
Platform: Prolific and MTurk

There were three different versions: <br>
**batch1)** audio + video: we started by collecting data in 6 participants including both audio and video. Since the recruitment was slow, we decided to remove the video recordings to see whether having the audio alone would speed up the data collection. 
<br>
**batch2)** audio only: we collected data from only 1 participant and thus decided that the video could not be the only problem. After testing participants on mturk and seeing the rate being even slower than Prolific, we decided to increase the screened participants on Prolific, to have a larger pool to test from. We screened 600 people out of which 357 had high social anxiety scores on MINI-SPIN (>= 6). <br>
**batch3)** audio + video: we tested 34 participants on Prolific using different histogram means and sd. So the difference between batches 1 and 3 is in the histograms we used, also for study 1 we do not have the video recordings as due to a technical mistake on Gorilla the audio files overwrote the video files which is now fixed to in batch3.

In batch3, the histogram mean and sd were changed so that we can less extreme values, so that when used in the following pilots to generate feedback, it can still be within the 10-100 limit. The histograms that were used in batches 1 and 2 have means of (10,20,30,40,60,70,80,90) and sd = 5, and the ones in batch3 had means of (20, 29, 37, 46, 54, 63, 71, 80) and sd = 3. Besides making the histograms narrower, we also did not want the mean values to be increments of 10 starting from 20, so that we could use them as feedback in one of the following pilot tasks (as non-random feedback to create zero prediction-error).



```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise", echo = TRUE)
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
```


```{r echo=FALSE}
df1 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRF_pilot_pred_nopic_vid_v5_task_main.csv") # Prolific, no picture taken

df2 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRF_pilot_pred_nopic_aud_v5_task_main.csv") # Prolific, no picture taken, only audio (no video)
```

```{r echo=FALSE}
# Check if both dataframes have the same columns in the same order.
# This step is to ensure that the concatenation process is correct.
if (!(identical(colnames(df1), colnames(df2)))) {
  stop("The two dataframes have different columns or order of columns!")
}

# # Find columns in df1 not in df2
# missing_in_df2 <- setdiff(colnames(df1), colnames(df2))
# print(missing_in_df2)
# 
# # Find columns in df2 not in df1
# missing_in_df1 <- setdiff(colnames(df2), colnames(df1))
# print(missing_in_df1)
# 
# # until we replace the first CSV file with the random_ID version, we need to do the following to run this code:
# colnames(df1)[colnames(df1) == "Participant.Public.ID"] <- "Random_ID"
# 
# # now if we run this again it should not give an error
# if (!(identical(colnames(df1), colnames(df2)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }
# 
# # they seem to have a different order too (delete these after adding the correct CSV file)
# cols_df1 <- colnames(df1)
# cols_df2 <- colnames(df2)
# 
# different_order <- which(cols_df1 != cols_df2)
# print(different_order)
# 
# if(length(different_order) > 0) {
#   print(paste("Differently ordered columns at positions:", 
#               paste(different_order, collapse = ", ")))
#   print(paste("In df1:", paste(cols_df1[different_order], collapse = ", ")))
#   print(paste("In df2:", paste(cols_df2[different_order], collapse = ", ")))
# } else {
#   print("The column order is identical.")
# }
# 
# # it seems in the new files, Random_ID is at the end of the dataframe
# cols <- colnames(df1)[colnames(df1) != "Random_ID"]
# df1 <- df1[, c(cols, "Random_ID")]
# 
# if (!(identical(colnames(df1), colnames(df2)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }

# now that the two files are the same let's continue.

# let's first look at the first 7 subjects in df1 and df2, who had different historagms means and sds
# 3. Concatenate the data frames
df <- rbind(df1, df2)
df_mood <- subset(df, Response.Type == "tooEarly")
df <- subset(df, Response.Type == "response")
df <- subset(df, Spreadsheet..Display == "Trials ")


df$m_hist <- ifelse(df$Spreadsheet..Histogram == "Histogram_1.png", 10,
                       ifelse(df$Spreadsheet..Histogram == "Histogram_2.png", 20,
                              ifelse(df$Spreadsheet..Histogram == "Histogram_3.png", 30,
                                     ifelse(df$Spreadsheet..Histogram == "Histogram_4.png", 40,
                                            ifelse(df$Spreadsheet..Histogram == "Histogram_5.png", 60,
                                                   ifelse(df$Spreadsheet..Histogram == "Histogram_6.png", 70,
                                                          ifelse(df$Spreadsheet..Histogram == "Histogram_7.png", 80,
                                                                 ifelse(df$Spreadsheet..Histogram == "Histogram_8.png", 90, NA))))))))  

```

<br> This figure below shows the relationship between histogram means and the predictions.<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred <- subset(df, Screen == "Prediction ")
df_conf <- subset(df, Screen == "Certainty rating ")
df_pred$Response <- as.numeric(as.character(df_pred$Response))
df_mood$Response <- as.numeric(as.character(df_mood$Response))


ggplot(df_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")
```

<br> The figure below shows the histogram and expectation values over time and across trials. <br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred_trial_nr <- df_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df_long <- df_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
ggplot(df_long, aes(x = trial_nr, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 1) # Separate plot for each ID, one column layout

```


<br> we will now make the same plots for mood (asking people how happy they are) and anxiety <br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create the plot with facet_wrap
  ggplot(df_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 1) # Separate plot for each ID, one column layout

```

The following people had different histogram means and smaller sd for histograms, so we plot them separately despite having a similar task design and also being from Prolific.

```{r echo=FALSE}
df3 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRF_pilot_pred_nopic_vid_v8_task_main.csv")   # Prolific, no picture taken, has both audio and video, histograms had different means () and sd = 3 to be narrower, this change was made to help us create histograms that would allow us create prediction errors more easily.

if (!(identical(colnames(df1), colnames(df3)))) {
  stop("The two dataframes have different columns or order of columns!")
}

# let's now look at the second 34 subjects in df3 who had different historagms means and sds
df3_mood <- subset(df3, Response.Type == "tooEarly")
df3 <- subset(df3, Response.Type == "response")
df3 <- subset(df3, Spreadsheet..Display == "Trials ")

df3$m_hist <- ifelse(df3$Spreadsheet..Histogram == "Histogram_1.png", 20,
                       ifelse(df3$Spreadsheet..Histogram == "Histogram_2.png", 29,
                              ifelse(df3$Spreadsheet..Histogram == "Histogram_3.png", 37,
                                     ifelse(df3$Spreadsheet..Histogram == "Histogram_4.png", 46,
                                            ifelse(df3$Spreadsheet..Histogram == "Histogram_5.png", 54,
                                                   ifelse(df3$Spreadsheet..Histogram == "Histogram_6.png", 63,
                                                          ifelse(df3$Spreadsheet..Histogram == "Histogram_7.png", 71,
                                                                 ifelse(df3$Spreadsheet..Histogram == "Histogram_8.png", 80, NA))))))))  

```
<br> <br> 
Let's now look at 34 subjects in batch3 who had different histogram means and sd: <br> <br> <br> 

```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred <- subset(df3, Screen == "Prediction ")
df3_conf <- subset(df3, Screen == "Certainty rating ")
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))
df3_mood$Response <- as.numeric(as.character(df3_mood$Response))


p <- ggplot(df3_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p)
```

<br><br><br>
Below we can see the histogram means and expectation values across trials:
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred_trial_nr <- df3_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df3_long <- df3_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
p <- ggplot(df3_long, aes(x = trial_nr, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(p)
```
<br><br><br>
**TO BE DONE: The data for the following subjects needs to be checked and may need to be excluded: “5aaa73e3f8a57d00010fe416”, “5dd671942b033b5ec8bc97b4”, “60cfd3a8a20665a4eeca0015”, “63fbd3e8b4865c6e1fb04614”.**


<br> we will now make the same plots for mood (asking people how happy they are) and anxiety <br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create the plot with facet_wrap
  ggplot(df3_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))

correlations_mean <- df3_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```



#### Pilot 5: prediction + feedback 
<br> 
**Goal:** To see whether positive PE can improve mood and anxiety. To do this we used two different versions of feedback (random vs non-random). If none of these succeed, we would need to create a third version where we take subjective predictions and histogram means into account to generate feedback.
Platform: MTurk

There were two different versions: <br>
**batch1)** With non-random feedback to generate positive, negative and zero PE's: https://app.gorilla.sc/admin/project/106374

**batch2)** With random feedback to generate positive, negative and zero PE's: https://app.gorilla.sc/admin/project/106055

Below we will be looking at the non-random feedback.
```{r echo=FALSE, warning=FALSE, message=FALSE}
df1 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_AMT_pilot_fdbk_nrand_typing_novid_v4_task_main.csv")
df2 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_AMT_pilot_fdbk_nrand_typing_novid_v5_task_main.csv")


df <- rbind(df1, df2)
df_mood <- subset(df, Response.Type == "tooEarly")
df <- subset(df, Response.Type == "response")
df <- subset(df, Spreadsheet..Display == "Trials ")

# defining histogram means
df$m_hist <- ifelse(df$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df$Spreadsheet..Histogram == "h8.png", 80, NA)))))))) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred <- subset(df, Screen == "Prediction ")
df_mood$Response <- as.numeric(as.character(df_mood$Response))

df_pred_trial_nr <- df_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# divide the df into three to look at people in smaller batches
unique_ids <- unique(df_pred_trial_nr$Random_ID)
# Step 2: Create ID ranges
range1 <- unique_ids[1:35]
range2 <- unique_ids[36:71]
range3 <- unique_ids[72:113]
# Step 3: Subset the dataframe
subset1 <- df_pred_trial_nr[df_pred_trial_nr$Random_ID %in% range1, ]
subset2 <- df_pred_trial_nr[df_pred_trial_nr$Random_ID %in% range2, ]
subset3 <- df_pred_trial_nr[df_pred_trial_nr$Random_ID %in% range3, ]
# Now subset1, subset2, and subset3 have the data for the respective ID ranges
```

<br><br> The relationship between Expectation and Histogram means are presented in the three plots below for the 113 participants. The second plot shows this relationship across trials. This is important especially since in this task people also received feedback (which was either positive, negative, or neutral), and we can see whether receiving feedback over time made them ignore the histogram values when trying to make predictions. <br> 

<br>For subjects 1-35:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p1 <- ggplot(subset1, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p1)

subset1$Response <- as.numeric(as.character(subset1$Response))

subset1_pred_trial_nr <- subset1 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset1_long <- subset1_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt1 <- ggplot(subset1_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt1)

```

Participant SUPAMT35697 seems to have done the task twice somehow, probably by trying to modify the URL to see if they can do the whole experiment again but Gorilla would only allow them to restart the node (one node part experiment section e.g. surprise task, questionnaires, consent form etc). The same thing seems to have happened for participants SUPAMT97235, SUPAMT69675 in the other two plots.

<br>For subjects 36-71:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p2 <- ggplot(subset2, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p2)


subset2$Response <- as.numeric(as.character(subset2$Response))


subset2_pred_trial_nr <- subset2 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset2_long <- subset2_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt2 <- ggplot(subset2_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt2)

```

<br>For subjects 72-113:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p3 <- ggplot(subset3, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p3)

subset3$Response <- as.numeric(as.character(subset3$Response))


subset3_pred_trial_nr <- subset3 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset3_long <- subset3_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt3 <- ggplot(subset3_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt3)

```

<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred$Response <- as.numeric(as.character(df_pred$Response))

correlations_mean <- df_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# divide the df into three to look at people in smaller batches
unique_ids_mood <- unique(df_mood$Random_ID)
# Step 2: Create ID ranges
range1 <- unique_ids_mood[1:35]
range2 <- unique_ids_mood[36:71]
range3 <- unique_ids_mood[72:113]
# Step 3: Subset the dataframe
subset1 <- df_mood[df_mood$Random_ID %in% range1, ]
subset2 <- df_mood[df_mood$Random_ID %in% range2, ]
subset3 <- df_mood[df_mood$Random_ID %in% range3, ]

# Now subset1, subset2, and subset3 have the data for the respective ID ranges
```

<br> We will now look at mood and anxiety over time, but we cannot really compare the ratings on Gorilla with Prolific because the Gorilla one did have feedback, whereas the Prolific one did not. <br>


```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(subset1, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

ggplot(subset2, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

ggplot(subset3, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

```

We repeated task with non-random feedback on Prolific to see whether the data quality would be better. Below you can see the results.

```{r echo=FALSE}
df3 <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRF_pilot_fdbk_nrand_typing_novid_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio)

# if (!(identical(colnames(df1), colnames(df3)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }

# let's now look at the second 34 subjects in df3 who had different historagms means and sds
df3_mood <- subset(df3, Response.Type == "tooEarly")
df3 <- subset(df3, Response.Type == "response")
df3 <- subset(df3, Spreadsheet..Display == "Trials ")

df3$m_hist <- ifelse(df3$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df3$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df3$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df3$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df3$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df3$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df3$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df3$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


```
<br> <br> 


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred <- subset(df3, Screen == "Prediction ")
df3_conf <- subset(df3, Screen == "Certainty rating ")
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))
df3_mood$Response <- as.numeric(as.character(df3_mood$Response))


p <- ggplot(df3_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p)
```

<br><br><br>
Below we can see the histogram means and expectation values across trials:
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred_trial_nr <- df3_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df3_long <- df3_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
p <- ggplot(df3_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(p)
```
<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))

correlations_mean <- df3_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```

Now let's make plots for each subject that show how prediction, feedback, histogram mean, anxiety, mood, confidence rating, PE (feedback - histogram), subj_PE (feedback-prediction).


```{r echo=FALSE, warning=FALSE, message=FALSE}
# lets add the feedback in the same column as the rest of the data since they are all from 0-100 values and since we want a long format data
library(dplyr)
library(ggplot2)
library(tidyr)
df_raw <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRF_pilot_fdbk_nrand_typing_novid_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio)

# create a new df that only keeps the columns we need

df <- df_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                      "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]


df <- df %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  filter(!is.na(Response))

# add the histogram values depending on file name:
df$m_hist <- ifelse(df$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  




# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df <- df %>%
  filter(
    (Display == "Trials ") |
    (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
    (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df$Trial.Number <- ifelse(df$Display == 'Mood ' | df$Display == 'Anxiety ', df$Trial.Number - 2, df$Trial.Number)
df$Display <- ifelse(df$Display == 'Mood ' | df$Display == 'Anxiety ', "Trials", df$Display)

# renaming the feedback column to fdbk
names(df)[names(df) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df$SubjPE <- ifelse(df$Screen == "Prediction ", df$fdbk - df$Response, NA)
df$PE <- ifelse(df$Screen == "Prediction ", df$fdbk - df$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df$fdbk <- ifelse(df$Screen == "Prediction ", df$fdbk, NA)
df$m_hist <- ifelse(df$Screen == "Prediction ", df$m_hist, NA)


long_df <- df %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df <- long_df[!is.na(long_df$Response), ]

  
# Selecting relevant columns from the original df
df <- df %>%
  select(-c(fdbk, m_hist, PE, SubjPE))

# Binding the rows together
df <- bind_rows(df, long_df)

```


```{r echo=FALSE, warning=FALSE, message=FALSE}

random_ids <- c("SUPPRF18834", "SUPPRF41746", "SUPPRF51534", "SUPPRF77371", "SUPPRF20648", 
                "SUPPRF71510", "SUPPRF43420", "SUPPRF54374", "SUPPRF62013", "SUPPRF96180", 
                "SUPPRF30203", "SUPPRF16716", "SUPPRF51230", "SUPPRF43536", "SUPPRF13138", 
                "SUPPRF95014", "SUPPRF98941", "SUPPRF77780", "SUPPRF94218", "SUPPRF69479")

df_s1 <- subset(df, Random_ID == "SUPPRF18834")
df_s2 <- subset(df, Random_ID == "SUPPRF69479")
df_s3 <- subset(df, Random_ID == "SUPPRF51534")
df_s4 <- subset(df, Random_ID == "SUPPRF77371")
df_s5 <- subset(df, Random_ID == "SUPPRF20648")
df_s6 <- subset(df, Random_ID == "SUPPRF71510")
df_s7 <- subset(df, Random_ID == "SUPPRF43420")
df_s8 <- subset(df, Random_ID == "SUPPRF94218")
df_s9 <- subset(df, Random_ID == "SUPPRF41746")
df_s10 <- subset(df, Random_ID == "SUPPRF54374")
df_s11 <- subset(df, Random_ID == "SUPPRF62013")
df_s12 <- subset(df, Random_ID == "SUPPRF96180")
df_s13 <- subset(df, Random_ID == "SUPPRF30203")
df_s14 <- subset(df, Random_ID == "SUPPRF16716")
df_s15 <- subset(df, Random_ID == "SUPPRF51230")
df_s16 <- subset(df, Random_ID == "SUPPRF43536")
df_s17 <- subset(df, Random_ID == "SUPPRF13138")
df_s18 <- subset(df, Random_ID == "SUPPRF95014")
df_s19 <- subset(df, Random_ID == "SUPPRF98941")
df_s20 <- subset(df, Random_ID == "SUPPRF77780")

list_of_dfs <- list(df_s1, df_s2, df_s3, df_s4, df_s5, df_s6, df_s7, df_s8, df_s9, df_s10, 
                    df_s11, df_s12, df_s13, df_s14, df_s15, df_s16, df_s17, df_s18, df_s19, df_s20)

plot_function <- function(df, title) {
  p <- ggplot(df, aes(x = Trial.Number, y = Response, color = Screen, group = Screen)) +
    geom_line() +
    theme_minimal() +
    labs(title = title,  # Set the title to the Random_ID
         x = "Trial Number",
         y = "Mood Ratings/Expectations/ PE",
         color = "") +
    facet_wrap(~ Screen, ncol = 2) +
    geom_hline(yintercept = 0)
  
  return(p)
}

# Use Map or mapply to apply the plot_function to each data frame and title in the list
list_of_plots <- Map(plot_function, list_of_dfs, random_ids)

# for (plot in list_of_plots) {
#   print(plot)
# }

print(list_of_plots[[1]])
print(list_of_plots[[2]])
print(list_of_plots[[3]])
print(list_of_plots[[4]])
print(list_of_plots[[5]])
print(list_of_plots[[6]])
print(list_of_plots[[7]])
print(list_of_plots[[8]])
print(list_of_plots[[9]])
print(list_of_plots[[10]])
print(list_of_plots[[11]])
print(list_of_plots[[12]])
print(list_of_plots[[13]])
print(list_of_plots[[14]])
print(list_of_plots[[15]])
print(list_of_plots[[16]])
print(list_of_plots[[17]])
print(list_of_plots[[18]])
print(list_of_plots[[19]])
print(list_of_plots[[20]])

# Open the PDF device
# pdf("8_var_plots_version2.pdf", width=7, height=5)
# 
# # Print each plot to the device
# for (plot in list_of_plots) {
#   print(plot)
# }
# 
# # Close the PDF device
# dev.off()

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# if you need to correlate variables using the long dataset, it is very simple
df$Response <- as.numeric(df$Response)
# cor(df[df$Screen == "PE", ]$Response, 
#     df[df$Screen == "SubjPE", ]$Response)

# and it is also simple if you want to do this by subject
# unique_ids <- unique(df$Random_ID)  # get the unique IDs
# cors_by_id <- numeric(length(unique_ids))  # initialize a numeric vector to store correlations

# List of IDs
ids <- c("SUPPRF18834", "SUPPRF41746", "SUPPRF51534", "SUPPRF77371", "SUPPRF20648", 
         "SUPPRF71510", "SUPPRF43420", "SUPPRF54374", "SUPPRF62013", "SUPPRF96180", 
         "SUPPRF30203", "SUPPRF16716", "SUPPRF51230", "SUPPRF43536", "SUPPRF13138", 
         "SUPPRF95014", "SUPPRF98941", "SUPPRF77780", "SUPPRF94218", "SUPPRF69479")

cors_by_id <- numeric(length(ids))

# Loop through each ID
for (i in seq_along(ids)) {
  # Subset data for current ID
  current_id <- ids[i]
  d_PE <- df[df$Screen == "PE" & df$Random_ID == current_id, ]$Response
  d_SubjPE <- df[df$Screen == "SubjPE" & df$Random_ID == current_id, ]$Response
  
  # Calculate correlation for the current ID
  cors_by_id[i] <- cor(d_PE, d_SubjPE, use = "complete.obs")  # 'complete.obs' to ignore NA values
}

# Print the correlations
# print(cors_by_id)

```

\newpage We now look at the relationship between PE (feedback - histogram_mean) and SubjPE (feedback - prediction):

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE and SubjPE
df_PE <- subset(df, Screen == "PE")
names(df_PE)[names(df_PE) == "Screen"] <- "Screen_PE"
names(df_PE)[names(df_PE) == "Response"] <- "Response_PE"


df_SubjPE <- subset(df, Screen == "SubjPE")
names(df_SubjPE)[names(df_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df_SubjPE)[names(df_SubjPE) == "Response"] <- "Response_SubjPE"

merged_df <- inner_join(df_SubjPE, df_PE, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID
correlations <- merged_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_PE, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between PE and SubjPE:", average_correlation)
print(message_to_print)

ggplot(merged_df, aes(x=Response_PE, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("PE: feedback - hist_mean") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed



# # Calculate Spearman rank correlation by Random_ID
# correlations <- merged_df %>%
#   group_by(Random_ID) %>%
#   summarise(correlation = cor(Response_PE, Response_SubjPE, method = "spearman", use = "complete.obs")) %>%
#   mutate(label = paste("Rho = ", round(correlation, digits = 2)))  # create a label for the plot
# 
# ggplot(merged_df, aes(x=Response_PE, y=Response_SubjPE)) +
#   geom_point(aes(color="Data Points")) +
#   geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +
#   labs(color="Legend") +
#   facet_wrap(~ Random_ID, scales = "free") +
#   theme_minimal() +
#   xlab("PE: feedback - hist_mean") +
#   ylab("SubjPE: feedback - prediction") +
#   # Add the correlation labels, with bold text
#   geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), 
#             hjust=1.1, vjust=1.1, size=3.5, fontface = "bold", inherit.aes=FALSE)

```


\newpage Let's now look at the relationship between SubjPE and Anxiety:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE, SubjPE, anxiety and mood:
df_Anxious <- subset(df, Screen == "Anxious")
names(df_Anxious)[names(df_Anxious) == "Screen"] <- "Screen_Ax"
names(df_Anxious)[names(df_Anxious) == "Response"] <- "Response_Ax"

df_Happy <- subset(df, Screen == "Happy")
names(df_Happy)[names(df_Happy) == "Screen"] <- "Screen_H"
names(df_Happy)[names(df_Happy) == "Response"] <- "Response_H"

final_df <- merged_df %>%
  inner_join(df_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df_Happy, by = c("Random_ID", "Trial.Number"))

# Calculate correlation by Random_ID for anxiety
correlations <- final_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE:", average_correlation)
print(message_to_print)


ggplot(final_df, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed

```

\newpage Below we can see the relationship between SubjPE and Mood/Happiness:

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Calculate correlation by Random_ID for mood
correlations <- final_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Happiness and SubjPE:", average_correlation)
print(message_to_print)

ggplot(final_df, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Mood/Happiness") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed

```

\newpage Now we will exclude some people who had given the same answers throughout the task and repeat everything again without them to see whether the group correlation changes for anxiety and mood. Below we can see the correlation between anxiety and SubjPE:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# 1) Exclude the following people as they were outliers/gave same answers: SUPPRF71510, SUPPRF54374, SUPPRF62013, SUPPRF94218
# 2) Have them having the same x and y-axis values to be more comparable
# 3) see if the mean correlation is significantly different from zero
# 4) do LME model with H or A ~ PE, Random_ID (random effect to get random intercept), PE (random effect to get random intercept)

# Create a vector of IDs to exclude
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_H, na.rm = TRUE)
y_range <- range(subset_df$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```

\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage I will now exclude subject SUPPRF16716 who rated always 0 for happiness and repeat the correlations again. The plot below shows the relationship between Anxiety and SubjPE:

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude'
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218", "SUPPRF16716")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_H, na.rm = TRUE)
y_range <- range(subset_df$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```

\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood after excluding one more subject:

```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```
\newpage We now will run everything again but this time using the objectibe PE (feedback - histogram_mean) instead of the subjecive one (feedback - prediction)

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude'
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218", "SUPPRF16716")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df$Response_PE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
\newpage This plot shows the relationship between PE and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and PE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_H, na.rm = TRUE)
y_range <- range(subset_df$Response_PE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_H, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```
```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and  PE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and PE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage <font size="3"> The following pilot had a non-randomly provided feedback, with one bigger positive feedback per participant to increase the size of positive PE to see how it would influence mood and anxiety, using the following experiment:https://app.gorilla.sc/admin/experiment/147683/design and task: pilot_fdbk_nrand_bigPE_typing_novid </font>

<br> 
<font size="3"> It may also be interesting to look at the relationship between the correlation between anxiety and PE, with mini-SPIN score to see how the levels of social anxiety may influence this relationship </font>
<br> <br> 
```{r echo=FALSE, warning=FALSE, message=FALSE}
df <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRL_pilot_fdbk_bignrnd_typ_novid.csv")
# Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge

df_mood <- subset(df, Response.Type == "tooEarly")
df <- subset(df, Response.Type == "response")
df <- subset(df, Spreadsheet..Display == "Trials ")

# defining histogram means
df$m_hist <- ifelse(df$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df$Spreadsheet..Histogram == "h8.png", 80, NA)))))))) 

```

<br> 
<font size="3"> The figure below shows the relationship between histogram means and the predictions.</font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred <- subset(df, Screen == "Prediction ")
df_conf <- subset(df, Screen == "Certainty rating ")
df_pred$Response <- as.numeric(as.character(df_pred$Response))
df_mood$Response <- as.numeric(as.character(df_mood$Response))


ggplot(df_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")
```

<br><br><br>
<font size="3"> Below we can see the histogram means and expectation values across trials:</font>
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred_trial_nr <- df_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df_long <- df_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
ggplot(df_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
```
<br><br><br>
<br> 
<font size="3"> we will now make the same plots for mood (asking people how happy they are) and anxiety </font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create the plot with facet_wrap
  ggplot(df_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_pred$Response <- as.numeric(as.character(df_pred$Response))

correlations_mean <- df_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

<br><br><br>
<font size="3"> Below we can see the average correlation and the histogram of the average. There were 2 people with random answers not taking the histograms into account, we can see them on the left side of the distribution having a negative or 0 correlation. </font>
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```

Now let's make plots for each subject that show how prediction, feedback, histogram mean, anxiety, mood, confidence rating, PE (feedback - histogram), subj_PE (feedback-prediction).


```{r echo=FALSE, warning=FALSE, message=FALSE}

df_raw <- read.csv("/Users/marjan/Desktop/pilot_surprise_SeptOCT2023/Pilot_surprise/SUP_PRL_pilot_fdbk_bignrnd_typ_novid.csv")   # Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge

# create a new df that only keeps the columns we need
df <- df_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                      "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]


df <- df %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  filter(!is.na(Response))

# add the histogram values depending on file name:
df$m_hist <- ifelse(df$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df <- df %>%
  filter(
    (Display == "Trials ") |
    (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
    (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df$Trial.Number <- ifelse(df$Display == 'Mood ' | df$Display == 'Anxiety ', df$Trial.Number - 2, df$Trial.Number)
df$Display <- ifelse(df$Display == 'Mood ' | df$Display == 'Anxiety ', "Trials", df$Display)

# renaming the feedback column to fdbk
names(df)[names(df) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df$SubjPE <- ifelse(df$Screen == "Prediction ", df$fdbk - df$Response, NA)
df$PE <- ifelse(df$Screen == "Prediction ", df$fdbk - df$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df$fdbk <- ifelse(df$Screen == "Prediction ", df$fdbk, NA)
df$m_hist <- ifelse(df$Screen == "Prediction ", df$m_hist, NA)


long_df <- df %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df <- long_df[!is.na(long_df$Response), ]

  
# Selecting relevant columns from the original df
df <- df %>%
  select(-c(fdbk, m_hist, PE, SubjPE))

# Binding the rows together
df <- bind_rows(df, long_df)

```


```{r echo=FALSE, warning=FALSE, message=FALSE}

random_ids <- unique(df$Random_ID)

list_of_dfs <- list()

for (i in seq_along(random_ids)) {
  x <- random_ids[i]  # Get the current value from random_ids
  df_si <- subset(df, Random_ID == x)  # Create the subset
  list_of_dfs[[paste0("df_s", i)]] <- df_si  # Add the subset to list_of_dfs
}

plot_function <- function(df, title) {
  p <- ggplot(df, aes(x = Trial.Number, y = Response, color = Screen, group = Screen)) +
    geom_line() +
    theme_minimal() +
    labs(title = title,  # Set the title to the Random_ID
         x = "Trial Number",
         y = "Mood Ratings/Expectations/ PE",
         color = "") +
    facet_wrap(~ Screen, ncol = 2) +
    geom_hline(yintercept = 0)
  
  return(p)
}

# Use Map or mapply to apply the plot_function to each data frame and title in the list
list_of_plots <- Map(plot_function, list_of_dfs, random_ids)


for (i in seq_along(list_of_plots)) {
  print(list_of_plots[[i]])
}

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# if you need to correlate variables using the long dataset, it is very simple
df$Response <- as.numeric(df$Response)

cors_by_id <- numeric(length(random_ids))

# Loop through each ID
for (i in seq_along(random_ids)) {
  # Subset data for current ID
  current_id <- random_ids[i]
  d_PE <- df[df$Screen == "PE" & df$Random_ID == current_id, ]$Response
  d_SubjPE <- df[df$Screen == "SubjPE" & df$Random_ID == current_id, ]$Response
  
  # Calculate correlation for the current ID
  cors_by_id[i] <- cor(d_PE, d_SubjPE, use = "complete.obs")  # 'complete.obs' to ignore NA values
}

# Print the correlations
# print(cors_by_id)
```


\newpage We now look at the relationship between PE (feedback - histogram_mean) and SubjPE (feedback - prediction):

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE and SubjPE
df_PE <- subset(df, Screen == "PE")
names(df_PE)[names(df_PE) == "Screen"] <- "Screen_PE"
names(df_PE)[names(df_PE) == "Response"] <- "Response_PE"


df_SubjPE <- subset(df, Screen == "SubjPE")
names(df_SubjPE)[names(df_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df_SubjPE)[names(df_SubjPE) == "Response"] <- "Response_SubjPE"

merged_df <- inner_join(df_SubjPE, df_PE, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID
correlations <- merged_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_PE, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between PE and SubjPE:", average_correlation)
print(message_to_print)

ggplot(merged_df, aes(x=Response_PE, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("PE: feedback - hist_mean") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20)) +
  scale_y_continuous(breaks = seq(-50, 50, by = 10), limits = c(-50, 50))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```

\newpage Let's now look at the relationship between SubjPE and Anxiety:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE, SubjPE, anxiety and mood:
df_Anxious <- subset(df, Screen == "Anxious")
names(df_Anxious)[names(df_Anxious) == "Screen"] <- "Screen_Ax"
names(df_Anxious)[names(df_Anxious) == "Response"] <- "Response_Ax"

df_Happy <- subset(df, Screen == "Happy")
names(df_Happy)[names(df_Happy) == "Screen"] <- "Screen_H"
names(df_Happy)[names(df_Happy) == "Response"] <- "Response_H"

final_df <- merged_df %>%
  inner_join(df_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df_Happy, by = c("Random_ID", "Trial.Number"))

# Calculate correlation by Random_ID for anxiety
correlations <- final_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(final_df$Response_Ax, na.rm = TRUE)
y_range <- range(final_df$Response_SubjPE, na.rm = TRUE)

ggplot(final_df, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
I will remove subject "SUPPRF67412" who has always scored 0 regardless of the feedback and see whether the results change.


```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude
ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

ggplot(subset_df, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
After removing this subject, the correlation becomes -0.18 from an average r of -0.167. <div style="background-color: #FFFF00"> We may need to look at their mini-SPIN scores, and also think about Georgina's comment about how we are asking the anxiety question, people, especially younger people may use the word "nervous" rather than "anxious".</div>

\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_H, na.rm = TRUE)
y_range <- range(subset_df$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<div style="background-color: #FFFF00"> It does make sense that now that we have a bigger correlation (r ~ 0.27 compared to 0.23 before) since we have bigger positive PE once per judge. Shall we also create bigger negative PE, and see whether the relationship with anxiety strengthens? </div>

I will now also remove the one data point for subjects "SUPPRF56321" and "SUPPRF93027" that may have caused the significant positive correlation, and repeat the above group correlstion, to see whether it influences the results. 


\newpage The next plot shows the same relationship for mood/happiness and SubjPE after removing trials that are outliers for subjects "SUPPRF56321" and "SUPPRF93027":
<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
# remove outliers, we can see from the plots that the outlier values are smaller than 20
subset_df <- subset_df %>%
  group_by(Random_ID) %>%
  filter(!(Random_ID %in% c("SUPPRF56321", "SUPPRF93027") & Response_H < 20))

# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

ggplot(subset_df, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<br>
The correlation reduces from 0.27 to 0.25 after removing those two data points.
<br>

\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood. The anxiety correlation now is significantly different from zero (this was not the case before)!

```{r echo=FALSE, warning=FALSE, message=FALSE}
print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage We now will run everything again but this time using the objective PE (feedback - histogram_mean) instead of the subjective one (feedback - prediction)

```{r echo=FALSE, warning=FALSE, message=FALSE}

ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df$Response_PE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
I will remove one data point for subject "SUPPRL44350" to see how much it is influencing the data

```{r echo=FALSE, warning=FALSE, message=FALSE}
ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df <- final_df[!final_df$Random_ID %in% ids_to_exclude, ]

# remove outliers, we can see from the plots that the outlier value is bigger than 50
subset_df <- subset_df %>%
  group_by(Random_ID) %>%
  filter(!(Random_ID %in% c("SUPPRF44350") & Response_Ax > 50))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)


ggplot(subset_df, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br> After removing the data point that was an outlier for subject "SUPPRL44350", the correlations between PE and axiety, and SubjPE and anxiety are similar (~ -0.179 vs -0.177) <br>

\newpage We will repeat the same thing for the relationship between PE and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and PE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df$Response_H, na.rm = TRUE)
y_range <- range(subset_df$Response_PE, na.rm = TRUE)


ggplot(subset_df, aes(x=Response_H, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```
<br>
Again, the relationship between SubjPE and mood, and PE and mood are very similar (r = 0.255 vs 0.245), which is great news if for the attention condition, IF we did not want to ask for subjective prediction.<br>



\newpage **TODO:** The following pilot had a randomly provided feedback (between 10-100), using the following experiment:https://app.gorilla.sc/admin/experiment/147682/design and task: surprise_Prolific_random_feedback_novideo



\newpage We now will run an LME (to be added):
```{r echo=FALSE, warning=FALSE, message=FALSE}
# library(lme4)


```
