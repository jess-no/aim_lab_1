---
title: "Attention pilot 1"
author: "Marjan Biria"
date: "2023-12-09"
output: 
    pdf_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lme4)
library(parameters)
library(broom.mixed)
```

\newpage
# Study description
In this pilot we tested people on the attention pilot, where no feedback was provided and no prediction was collected. We have m_hist, anxiety, mood and certainty ratings for this pilot. This is the experiment on Gorilla: https://app.gorilla.sc/admin/project/115369
This is the task version used: https://app.gorilla.sc/admin/task/712861/editor?version=3  
The Externally focused attention condition was presented first, followed by the internally focused attention. Each condition had 24 trials. I will keep the mood and anxiety ratings before they start the task to look at baseline anxiety and mood in the following analysis.

```{r echo=FALSE, warning=FALSE, message=FALSE}
df_att <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_no_fdbk_attention_vid/SUP_PRF_pilot_no_fdbk_attention_vid_v3/SUP_PRF_pilot_no_fdbk_attention_vid_v3_task_main.csv")
df_att_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_no_fdbk_attention_vid/SUP_PRF_pilot_no_fdbk_attention_vid_v3/SUP_PRF_pilot_no_fdbk_attention_vid_v3_mini_spin.csv")

df_att <- df_att[, c("Event.Index", "Trial.Number", "Random_ID", "Spreadsheet..Histogram", "Screen", "Display", "Response", "Response.Type", "Object.ID" )]
df_att <- df_att %>% filter(Random_ID != "SUPPRF17915")
df_att_spin <- df_att_spin %>% filter(Random_ID != "SUPPRF17915")

# let's also exclude the mood and anxiety ratings during practice
df_att <- df_att %>% filter(!Event.Index %in% c(15, 17))
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

df_att$m_hist <- case_when(
  df_att$Spreadsheet..Histogram == "h1.png" ~ 20,
  df_att$Spreadsheet..Histogram == "h2.png" ~ 29,
  df_att$Spreadsheet..Histogram == "h3.png" ~ 37,
  df_att$Spreadsheet..Histogram == "h4.png" ~ 46,
  df_att$Spreadsheet..Histogram == "h5.png" ~ 54,
  df_att$Spreadsheet..Histogram == "h6.png" ~ 63,
  df_att$Spreadsheet..Histogram == "h7.png" ~ 71,
  df_att$Spreadsheet..Histogram == "h8.png" ~ 80,
  TRUE ~ NA_real_
)

df_att <- df_att %>%
  dplyr::filter(
    (Display == "Trials - Externally Focused Attention") |
    (Display == "Trials - Self Focused Attention") |
    (Display == "Anxiety ") |
    (Display == "Mood ") 
  )

df_hist <- df_att %>%
  filter(Screen == "Introducing judge") %>%
  select(Event.Index, Response.Type, Object.ID, Random_ID, Trial.Number, Screen, Display, m_hist, Spreadsheet..Histogram)

df_hist <- df_hist %>%
  mutate(Screen = ifelse(Screen == "Introducing judge", "m_hist", Screen))

df_hist_modified <- df_hist %>%
  select(Event.Index, Random_ID, Spreadsheet..Histogram, Trial.Number, m_hist, Screen, Display, Response.Type, Object.ID) %>%
  dplyr::rename(Response = m_hist)

df_hist_modified <- df_hist_modified %>%
  mutate(Response = as.character(Response))

df_attention <- bind_rows(df_att, df_hist_modified)


# setting Mood and Anxiety trial numbers to start from 0 for baseline, and 1 for task, also making sure we match the anxiety and mood trials with the experiment trials
# experiment trials run from 1-24 per condition whereas for mood and anxiety rating this goes continuously from 1-50; we will change this in the next version of the task
df_attention$Trial.Number <- ifelse(df_attention$Display == 'Mood ' | df_attention$Display == 'Anxiety ', df_attention$Trial.Number - 2, df_attention$Trial.Number)

df_attention <- df_attention %>%
  mutate(Display = case_when(
    Screen == "m_hist" ~ "m_hist",
    Display == 'Mood ' & Trial.Number <= 26 ~ 'Mood_OUT',
    Display == 'Anxiety ' & Trial.Number <= 26 ~ 'Anxiety_OUT',
    Display == 'Mood ' & Trial.Number > 26 ~ 'Mood_IN',
    Display == 'Anxiety ' & Trial.Number > 26 ~ 'Anxiety_IN',
    TRUE ~ Display  
  ))

df_attention <- df_attention %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

df_attention <- df_attention %>% filter(Trial.Number != -1)

df_attention <- df_attention %>%
  select(-Event.Index, -Object.ID, -m_hist, -Response.Type, -Spreadsheet..Histogram)

# Let's score mini-spin and add its total score to df_attention per subject
df_att_spin <- df_att_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears."
  )

df_att_spin_test <- df_att_spin %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE))

df_att_spin <- df_att_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()


df_attention_spin <- merge(df_attention, df_att_spin[, c("Random_ID", "mini_SPIN_total")], by = "Random_ID", all.x = TRUE)

df_attention_spin$Social_Anxiety <- ifelse(df_attention_spin$mini_SPIN_total >= 6, "high", "low")

# write.csv(df_attention_spin, file = "df_attention_pilots_with_spin", row.names = FALSE)
```


\newpage 
# Anxiety and Mood ratings within subjects
There were 3 people that had given the same rating across all trials. Some people show the pattern we expect (lower anxiety, higher mood from IN to OUT conditions) but not everyone.

**QUESTION**: How can we best plot the group plot? We cannot plot the individual points anymore, as they would become hard to read; we could average within subjects but again not sure if this is the best approach? I also wonder maybe the fact that there was no feedback (per trial, only at the end) was not stressful enough. It would be interesting to pilot it with the feedback and prediction.  
**Let's also think how to have the feedback across both conditions: we do want to keep feedback constant to be comparable between conditions, right? If so, we would need to have 2 x 48 trials?**

```{r echo=FALSE, warning=FALSE, message=FALSE}
# df_attention_spin <- read.csv("df_attention_pilots_with_spin.csv")

df_attention_spin_f1 <- df_attention_spin %>% filter(Display != "m_hist")
random_ids <- unique(df_attention$Random_ID)

unique_high_anxiety_ids <- df_attention_spin_f1 %>%
  filter(Social_Anxiety == "high") %>%
  distinct(Random_ID) %>%
  nrow()

total_n <- length(unique(df_attention_spin_f1$Random_ID))
message_to_print <- paste(unique_high_anxiety_ids, "subjects out of", total_n,"had high social anxiety")
print(message_to_print)


list_of_dfs <- list()

for (i in seq_along(random_ids)) {
  x <- random_ids[i]  # Get the current value from random_ids
  df_si <- subset(df_attention_spin_f1, Random_ID == x)  # Create the subset
  list_of_dfs[[paste0("df_s", i)]] <- df_si  # Add the subset to list_of_df10s
}

plot_function <- function(df_attention_spin_f1, title) {
  p <- ggplot(df_attention_spin_f1, aes(x = Display, y = Response, fill = Social_Anxiety, color = Screen)) +
    geom_boxplot(outlier.colour = "black", outlier.shape = 16, 
                 outlier.size = 2, notch = TRUE) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
    theme_minimal() +
    labs(x = "Display", y = "Response", fill = "Social Anxiety") +
    scale_fill_manual(values = c("low" = "blue", "high" = "red")) +
    scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
    ggtitle(paste("Anxiety and Mood ratings for subject:", title)) +
    xlab("") + 
    ylab("Mood/Anxiety ratings") +
    facet_wrap(~Display, scales = "free")

  return(p)
}

list_of_plots <- Map(plot_function, list_of_dfs, random_ids)

for (i in seq_along(list_of_plots)) {
  print(list_of_plots[[i]])
}

```



\newpage
# Relationship between mini_SPIN and momentary anxiety ratings 

The plot below show the relationship between the (average) anxiety ratings on the task and total mini_SPIN scores.  

```{r echo=FALSE, warning=FALSE, message=FALSE}
avg_response <- df_attention_spin_f1 %>%
  group_by(Random_ID, Display) %>%
  summarise(avg_Response = mean(Response, na.rm = TRUE)) %>%
  ungroup()

wide_avg_response <- avg_response %>%
  pivot_wider(names_from = Display, values_from = avg_Response)

final_df <- df_attention_spin_f1 %>%
  select(Random_ID, mini_SPIN_total, Social_Anxiety) %>%
  distinct(Random_ID, .keep_all = TRUE) %>%
  left_join(wide_avg_response, by = "Random_ID") %>%
  pivot_longer(
    cols = c(Anxiety_IN, Anxiety_OUT, Mood_IN, Mood_OUT),
    names_to = "Screens",
    values_to = "Response"
  )

final_df <- final_df %>%
  mutate(Display = sapply(strsplit(Screens, "_"), `[`, 1))


df_ax <- final_df %>% filter(Screens == "Anxiety_IN" | Screens == "Anxiety_OUT")
df_M <-  final_df %>% filter(Screens == "Mood_IN" | Screens == "Mood_OUT")


correlations_ax <- df_ax %>%
  group_by(Screens) %>%
  summarise(correlation = cor(mini_SPIN_total, Response, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  

average_correlation_ax <- mean(correlations_ax$correlation, na.rm = TRUE)
message_to_print <- paste("correlation between mini_SPIN_total and average anxiety ratings:", average_correlation_ax)
print(message_to_print)


ggplot(df_ax, aes(x=mini_SPIN_total, y=Response)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue") +     
  labs(color="Legend") +
  facet_wrap(~ Screens, scales = "free") +
  theme_minimal() +
  xlab("mini_SPIN_total") + 
  ylab("Average Momentary Anxiety Ratings") +
  geom_text(data=correlations_ax, aes(x=Inf, y=Inf, label=label, group=Screens), hjust=1.5, vjust=4.1, size=2.7, fontface = "bold", inherit.aes=FALSE) 

```



\newpage
# Relationship between mini_SPIN and momentary mood ratings 

The plot below show the relationship between (average) mood ratings on the task and the total mini_SPIN scores.  

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_M <- df_M %>%
  group_by(Screens) %>%
  summarise(correlation = cor(mini_SPIN_total, Response, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  

average_correlation_M <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print <- paste("correlation between mini_SPIN_total and average anxiety ratings:", average_correlation_M)
print(message_to_print)


ggplot(df_M, aes(x=mini_SPIN_total, y=Response)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue") +     
  labs(color="Legend") +
  facet_wrap(~ Screens, scales = "free") +
  theme_minimal() +
  xlab("mini_SPIN_total") + 
  ylab("Average Momentary Mood Ratings") +
  geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Screens), hjust=1.5, vjust=4.1, size=2.7, fontface = "bold", inherit.aes=FALSE) 
```


\newpage
# Average Anxiety in IN and OUT attention conditions
The plot below show the average anxiety ratings in IN and OUT attention conditions where people paid internal and external attention respectively. I think without the outlier (black dot), the difference becomes bigger, will test it later.


```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(df_ax, aes(x = Display, y = Response, color = Screens)) +
    geom_boxplot(outlier.colour = "black", outlier.shape = 16, 
                 outlier.size = 2, notch = TRUE) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
    theme_minimal() +
    labs(x = "Display", y = "Response", fill = "Social Anxiety") +
    # scale_fill_manual(values = c("low" = "blue", "high" = "red")) +
    scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
    ggtitle(paste("Average mood ratings in IN and OUT attention conditions")) +
    xlab("") + 
    ylab("Average Anxiety Ratings") +
    facet_wrap(~Screens, scales = "free")

```

\newpage
# Average Mood in IN and OUT attention conditions

The plot below show the average mood ratings in IN and OUT attention conditions where people paid internal and external attention respectively.


```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(df_M, aes(x = Display, y = Response, color = Screens)) +
    geom_boxplot(outlier.colour = "black", outlier.shape = 16, 
                 outlier.size = 2, notch = TRUE) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
    theme_minimal() +
    labs(x = "Display", y = "Response", fill = "Social Anxiety") +
    # scale_fill_manual(values = c("low" = "blue", "high" = "red")) +
    scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
    ggtitle(paste("Average mood ratings in IN and OUT attention conditions")) +
    xlab("") + 
    ylab("Average Mood Ratings") +
    facet_wrap(~Screens, scales = "free")

```